<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT (Stable v2.9)</title>

<style>
body {
  font-family: Arial, system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background:#f2f4f7;
}

/* 메인 컨테이너 */
.container {
  max-width: 1100px;
  margin: 20px auto;
  background:#fff;
  border-radius:10px;
  padding:20px 24px 40px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  display:none;
}

h1 { margin-top:0; }

/* 상단 컨트롤 박스 */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:16px;
  padding:12px;
  background:#f7f9fc;
  border-radius:8px;
}

.controls > div { min-width: 180px; }

label {
  font-size:14px;
  font-weight:600;
  display:block;
  margin-bottom:4px;
}

select,
input[type="number"],
input[type="text"],
textarea {
  width:100%;
  padding:6px 8px;
  font-size:14px;
  box-sizing:border-box;
}

button {
  padding:8px 14px;
  font-size:14px;
  cursor:pointer;
  border-radius:6px;
  border:1px solid #1f6feb;
  background:#1f6feb;
  color:#fff;
}

button.secondary {
  background:#fff;
  color:#1f2933;
  border-color:#cbd2e1;
}

button.danger {
  background:#e11d48;
  border-color:#e11d48;
  color:#fff;
}

#timer {
  font-size:18px;
  font-weight:bold;
  color:#e11d48;
}

#modeDesc {
  font-size:13px;
  color:#4b5563;
  margin-top:4px;
}

/* 문제 블록 */
.question-block {
  margin-bottom:20px;
  padding-bottom:12px;
  border-bottom:1px solid #e5e7eb;
}

.question-title {
  font-weight:bold;
  margin-bottom:8px;
}

.meta {
  font-size:12px;
  color:#6b7280;
  margin-bottom:4px;
}

.option { margin:4px 0; font-size:14px; }

/* 결과 박스 */
#resultBox {
  margin-top:24px;
  padding:16px;
  border-radius:8px;
  background:#ecfeff;
  border:1px solid #7dd3fc;
}

#resultBox h3 { margin-top:0; }

.explanation {
  font-size:13px;
  margin-top:4px;
  color:#334155;
}

/* 패널 */
.panel-row {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:20px;
}

.panel {
  flex:1;
  min-width:260px;
  background:#f9fafb;
  border-radius:8px;
  padding:10px 12px;
  border:1px solid #e5e7eb;
  max-height:300px;
  overflow:auto;
}

.panel h3 {
  margin-top:0;
  font-size:15px;
}

.note-item,
.score-item {
  font-size:12px;
  margin-bottom:6px;
  border-bottom:1px dashed #e5e7eb;
  padding-bottom:4px;
}

.tag {
  display:inline-block;
  font-size:11px;
  padding:1px 6px;
  border-radius:999px;
  margin-left:4px;
  background:#e5e7eb;
}

.tag.A { background:#dbeafe; }
.tag.C { background:#fef3c7; }

/* 비밀번호 게이트 */
#gateOverlay {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#gateBox {
  background:#f9fafb;
  border-radius:12px;
  padding:24px 26px;
  width:320px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

#gateBox input {
  width:100%;
  padding:8px;
  margin-top:8px;
}

#gateMessage { font-size:12px; color:#dc2626; margin-top:6px; height:16px; }
#gateBox button { width:100%; margin-top:10px; }

</style>
</head>
<body>

<!-- 비밀번호 게이트 -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE 연습 사이트</h2>
    <p style="font-size:13px;color:#4b5563;">비밀번호를 입력하세요.</p>
    <input type="password" id="gatePassword" />
    <div id="gateMessage"></div>
    <button id="gateBtn">입장</button>
  </div>
</div>

<!-- 메인 컨텐츠 -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    챕터 / 유형 / 모드 / 시간 선택 후 "시험 시작"을 누르세요.
  </p>

  <div class="controls">
    <div>
      <label>챕터 선택</label>
      <select id="chapterSelect"></select>
    </div>

    <div>
      <label>유형 선택</label>
      <select id="typeSelect">
        <option value="all">전체</option>
        <option value="A">A-type</option>
        <option value="C">C-type</option>
      </select>
    </div>

    <div>
      <label>문제 수</label>
      <input id="countInput" type="number" value="10" min="1" max="200" />
    </div>

    <div>
      <label>타이머(분)</label>
      <input id="timerInput" type="number" value="60" />
    </div>

    <div>
      <label>출제 모드</label>
      <select id="modeSelect">
        <option value="normal">일반</option>
        <option value="wrong">오답만</option>
        <option value="weak">약점 챕터</option>
      </select>
    </div>

    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button id="startBtn">시험 시작</button>
      <button id="submitBtn" class="secondary" disabled>제출</button>
      <button id="resetBtn" class="secondary" disabled>초기화</button>
    </div>

    <div style="margin-left:auto;text-align:right;">
      <div id="timer">Timer: OFF</div>
      <div id="modeDesc"></div>
    </div>
  </div>

  <div id="quizBox"></div>
  <div id="resultBox"></div>

  <div class="panel-row">
    <div class="panel">
      <h3>오답노트</h3>
      <div id="wrongNotesBox"></div>
      <button class="secondary" onclick="clearWrongNotes()">오답 초기화</button>
    </div>

    <div class="panel">
      <h3>점수 기록</h3>
      <div id="scoreHistoryBox"></div>
      <button class="secondary" onclick="clearScoreHistory()">점수 초기화</button>
    </div>

    <div class="panel">
      <h3>문제 추가</h3>
      <form id="addQuestionForm">
        <label>ID</label>
        <input id="addId" type="text" required />
        <label>챕터</label>
        <select id="addChapter"></select>
        <label>유형</label>
        <select id="addType">
          <option value="A">A-type</option>
          <option value="C">C-type</option>
        </select>
        <label>문제</label>
        <textarea id="addText" required></textarea>
        <label>보기 A/B/C/D</label>
        <input id="addOpA" required />
        <input id="addOpB" required />
        <input id="addOpC" required />
        <input id="addOpD" required />
        <label>정답(0~3)</label>
        <input id="addAnswer" type="number" min="0" max="3" value="0" />
        <label>해설(optional)</label>
        <textarea id="addExplanation"></textarea>
        <button type="submit" class="secondary" style="margin-top:8px;">추가</button>
      </form>

      <hr>
      <h4>JSON 업로드</h4>
      <input type="file" id="uploadFileInput" accept=".json" />
      <button class="secondary" id="uploadFileBtn">업로드</button>

      <hr>
      <button class="danger" id="clearCustomBtn">사용자 문제 제거</button>
      <button class="secondary" id="exportCustomBtn">문제 다운로드</button>
    </div>
  </div>
</div>

<script>
/******************************************************************
 * 0. 설정 — 비밀번호
 ******************************************************************/
const APP_PASSWORD = "cre2025";

/******************************************************************
 * 1. 기본 문제 데이터
 ******************************************************************/
const BASE_QUESTIONS = [
  { id:"Q1", chapter:"챕터 4 - Statistical Concepts", type:"C",
    text:"Exponential 분포에서 MTBF = 800h일 때 R(400)은?",
    options:["0.50","0.61","0.37","0.80"], answer:1,
    explanation:"R = exp(-400/800)=exp(-0.5)=0.606" },

  { id:"Q2", chapter:"챕터 4 - Statistical Concepts", type:"C",
    text:"Exponential 시험 T=4000h, r=3, 90% MTBF 하한 공식?",
    options:["2T/χ²(lower)","2T/χ²(upper)","T/r","T/(r-1)"],
    answer:1, explanation:"Lower LCB = 2T / χ²(df=2r; upper α)" },

  { id:"Q3", chapter:"챕터 4 - Statistical Concepts", type:"C",
    text:"정규(50,10)에서 40 이하 확률?",
    options:["0.16","0.30","0.50","0.84"], answer:0,
    explanation:"Z=-1 → Φ(-1)=0.1587" },

  { id:"Q4", chapter:"챕터 4 - Statistical Concepts", type:"A",
    text:"Exponential R(MTBF) 값?",
    options:["0.50","0.37","0.63","0.90"], answer:1,
    explanation:"exp(-1)=0.37" },

  { id:"Q5", chapter:"챕터 4 - Statistical Concepts", type:"A",
    text:"Weibull β>1 의미?",
    options:["초기고장","마모고장","고장률 일정","무작위"], answer:1,
    explanation:"β>1 = wear-out" },

  /* ===== Testing & Modeling ===== */
  { id:"Q6", chapter:"챕터 7 - Testing and Modeling", type:"A",
    text:"ALT의 목적?",
    options:["한계 검사","단기간 수명예측","Cpk 향상","파괴시험"],
    answer:1, explanation:"Accelerated Life Test = 수명 예측" },

  { id:"Q7", chapter:"챕터 7 - Testing and Modeling", type:"A",
    text:"Peck 모델은 무엇을 고려?",
    options:["온도","습도","온도+습도","전압+진동"], answer:2,
    explanation:"T & RH 기반" },

  { id:"Q8", chapter:"챕터 7 - Testing and Modeling", type:"A",
    text:"Step-stress 시험?",
    options:["유지","단계 증가","단계 감소","무작위"],
    answer:1, explanation:"Step-stress = 스트레스 증가" },

  { id:"Q9", chapter:"챕터 7 - Testing and Modeling", type:"C",
    text:"병렬 (0.7,0.8,0.9) 시스템 신뢰도?",
    options:["0.90","0.97","0.50","0.80"], answer:1,
    explanation:"1-(0.3*0.2*0.1)=0.994" },

  { id:"Q10", chapter:"챕터 7 - Testing and Modeling", type:"C",
    text:"Perfect Standby: Active=0.9, Standby=0.8",
    options:["0.90","0.92","0.98","0.99"], answer:2,
    explanation:"0.9 + 0.1*0.8 = 0.98" },

  /* ===== Risk ===== */
  { id:"Q11", chapter:"챕터 3 - Risk Management", type:"A",
    text:"CCF 정의?",
    options:["독립고장","동일원인 병렬고장","환경무관","회복고장"],
    answer:1, explanation:"Common cause" },

  { id:"Q12", chapter:"챕터 3 - Risk Management", type:"A",
    text:"FTA 장점?",
    options:["모든 고장","추세 분석","Top event 중심","상호작용"],
    answer:2, explanation:"Top event 기반" },

  /* ===== Design ===== */
  { id:"Q13", chapter:"챕터 8 - Reliability Designs", type:"A",
    text:"DOE 블록 정의?",
    options:["요인 수준","균질 그룹","반복","상호작용"], answer:1,
    explanation:"Block = 균질 조건 그룹" },

  { id:"Q14", chapter:"챕터 8 - Reliability Designs", type:"A",
    text:"Taguchi Loss?",
    options:["규격내=0","제곱 증가","선형 증가","상수"], answer:1,
    explanation:"L=k(y-T)^2" },

  { id:"Q15", chapter:"챕터 8 - Reliability Designs", type:"A",
    text:"Robust Design 목적?",
    options:["비용↓","Cpk↑","Noise 민감도↓","시간↓"],
    answer:2, explanation:"잡음 감소" },

  /* ===== Maintainability ===== */
  { id:"Q16", chapter:"챕터 9 - Maintainability", type:"A",
    text:"RCM 목적?",
    options:["비용↓","가용성 추정","중요 고장 예방","동일주기 교체"],
    answer:2, explanation:"중요 모드 중심" },

  { id:"Q17", chapter:"챕터 9 - Maintainability", type:"C",
    text:"MTBM=1700, MDT=34 Ao?",
    options:["0.90","0.95","0.98","0.99"], answer:2,
    explanation:"1700/(1700+34)=0.981" },
];

/******************************************************************
 * 2. LocalStorage Helper
 ******************************************************************/
const loadWrongNotes = () => JSON.parse(localStorage.getItem("creWrongNotes")||"[]");
const saveWrongNotes = v => localStorage.setItem("creWrongNotes", JSON.stringify(v));

const loadScoreHistory = () => JSON.parse(localStorage.getItem("creScoreHistory")||"[]");
const saveScoreHistory = v => localStorage.setItem("creScoreHistory", JSON.stringify(v));

const loadCustomQuestions = () => JSON.parse(localStorage.getItem("creCustomQuestions")||"[]");
const saveCustomQuestions = v => localStorage.setItem("creCustomQuestions", JSON.stringify(v));

/******************************************************************
 * 3. 동적 챕터 리스트 생성
 ******************************************************************/
function refreshChapterDropdown() {
  const chSel = document.getElementById("chapterSelect");
  const chAdd = document.getElementById("addChapter");

  const all = BASE_QUESTIONS.concat(loadCustomQuestions());
  const chapters = new Set(["전체"]);

  all.forEach(q => chapters.add(q.chapter));

  let htmlMain = "";
  let htmlAdd = "";

  chapters.forEach(ch => {
    htmlMain += `<option value="${ch==='전체'?'all':ch}">${ch}</option>`;
    if (ch !== "전체") htmlAdd += `<option value="${ch}">${ch}</option>`;
  });

  chSel.innerHTML = htmlMain;
  chAdd.innerHTML = htmlAdd;
}

/******************************************************************
 * 4. 문제 전체 가져오기
 ******************************************************************/
const getAllQuestions = () => BASE_QUESTIONS.concat(loadCustomQuestions());

/******************************************************************
 * 5. 오답 / 점수 표시
 ******************************************************************/
function renderWrongNotes(){
  const notes = loadWrongNotes();
  const box = document.getElementById("wrongNotesBox");
  if (!notes.length){
    box.innerHTML = `<div style="font-size:12px;color:#888;">오답 없음</div>`;
    return;
  }
  box.innerHTML = notes.map(n => `
    <div class="note-item">
      <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
      <div>${n.text}</div>
      <div style="font-size:11px;color:#666;">${n.chapter} · ${n.missCount}회 · ${n.lastDate}</div>
    </div>
  `).join("");
}

function renderScoreHistory(){
  const hist = loadScoreHistory();
  const box = document.getElementById("scoreHistoryBox");
  if (!hist.length){
    box.innerHTML = `<div style="font-size:12px;color:#888;">기록 없음</div>`;
    return;
  }
  box.innerHTML = hist.slice().reverse().map(h => `
    <div class="score-item">
      <b>${h.date}</b> — ${h.correct}/${h.total} (${Math.round(h.correct/h.total*100)}%)
      <div style="font-size:11px;color:#555;">${h.mode} · ${h.durationSec}s</div>
    </div>
  `).join("");
}

function clearWrongNotes(){
  if (!confirm("오답노트를 모두 삭제할까요?")) return;
  saveWrongNotes([]);
  renderWrongNotes();
}

function clearScoreHistory(){
  if (!confirm("점수 기록을 모두 삭제할까요?")) return;
  saveScoreHistory([]);
  renderScoreHistory();
}

/******************************************************************
 * 6. 타이머
 ******************************************************************/
let timerId=null, timerSeconds=0, quizStarted=false, quizStartTime=null, currentQuiz=[];

function stopTimer(){
  if (timerId !== null){
    clearInterval(timerId);
    timerId = null;
  }
}

function updateTimerDisplay(){
  const el=document.getElementById("timer");
  if (timerSeconds<=0){
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSeconds/60)).padStart(2,"0");
  const s = String(timerSeconds%60).padStart(2,"0");
  el.textContent = `남은 시간: ${m}:${s}`;
}

function startTimer(sec){
  stopTimer();
  timerSeconds = sec;
  updateTimerDisplay();

  if(sec<=0) return;

  timerId = setInterval(()=>{
    timerSeconds--;
    updateTimerDisplay();
    if(timerSeconds<=0){
      stopTimer();
      alert("시간 종료! 자동 제출됩니다.");
      submitQuiz(true);
    }
  },1000);
}

/******************************************************************
 * 7. 배열 섞기
 ******************************************************************/
const shuffleArray = arr => {
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
};

/******************************************************************
 * 8. 문제 화면 출력
 ******************************************************************/
function renderQuiz(){
  const box=document.getElementById("quizBox");
  box.innerHTML="";

  currentQuiz.forEach((q,idx)=>{
    let h = `
      <div class="question-block">
        <div class="question-title">Q${idx+1}. ${q.text}</div>
        <div class="meta">${q.id} · ${q.chapter} · ${q.type}</div>
    `;
    q.options.forEach((op,j)=>{
      h += `
        <div class="option">
          <label>
            <input type="radio" name="q${idx}" value="${j}">
            ${String.fromCharCode(65+j)}. ${op}
          </label>
        </div>`;
    });
    h += "</div>";
    box.innerHTML += h;
  });
}

/******************************************************************
 * 9. 출제 모드
 ******************************************************************/
function buildQuestionPool(){
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  const all = getAllQuestions();
  const notes = loadWrongNotes();

  if(mode==="normal"){
    return {
      pool: all.filter(q =>
        (ch==="all" || q.chapter===ch) &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:null
    };
  }

  if(mode==="wrong"){
    const set = new Set(notes.map(n=>n.id));
    return {
      pool: all.filter(q =>
        set.has(q.id) &&
        (ch==="all" || q.chapter===ch) &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:null
    };
  }

  if(mode==="weak"){
    if(!notes.length){
      alert("오답노트가 없습니다.");
      return { pool:[], autoChapter:null };
    }
    const count={};
    notes.forEach(n => count[n.chapter]=(count[n.chapter]||0)+n.missCount);

    let weak=null, max=-1;
    for(const c in count){
      if(count[c]>max){ weak=c; max=count[c]; }
    }

    return {
      pool: all.filter(q =>
        q.chapter===weak &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:weak
    };
  }
}

/******************************************************************
 * 10. 시험 시작
 ******************************************************************/
function startQuiz(){
  const cnt = Number(document.getElementById("countInput").value);
  const tm  = Number(document.getElementById("timerInput").value);

  const { pool, autoChapter } = buildQuestionPool();
  if(!pool.length){
    alert("출제 가능한 문제가 없습니다.");
    return;
  }

  currentQuiz = shuffleArray(pool).slice(0, cnt || pool.length);
  renderQuiz();

  quizStarted=true;
  quizStartTime = Date.now();

  document.getElementById("resultBox").innerHTML="";
  document.getElementById("startBtn").disabled=true;
  document.getElementById("submitBtn").disabled=false;
  document.getElementById("resetBtn").disabled=false;

  const modeTxt=[];
  const mode=document.getElementById("modeSelect").value;

  modeTxt.push(
    mode==="normal" ? "일반" :
    mode==="wrong"  ? "오답만" :
                      "약점"
  );

  if(mode==="weak" && autoChapter)
    modeTxt.push(`챕터=${autoChapter}`);
  else {
    const ch=document.getElementById("chapterSelect").value;
    modeTxt.push(ch==="all" ? "전체" : `챕터=${ch}`);
  }

  const tp=document.getElementById("typeSelect").value;
  modeTxt.push(tp==="all" ? "A+C" : `유형=${tp}`);
  modeTxt.push(`문제=${currentQuiz.length}`);

  document.getElementById("modeDesc").textContent = modeTxt.join(" / ");

  startTimer(tm>0 ? tm*60 : 0);
}

/******************************************************************
 * 11. 제출 & 채점
 ******************************************************************/
function submitQuiz(auto=false){
  if(!quizStarted) return;
  quizStarted=false;
  stopTimer();

  const duration = Math.round((Date.now()-quizStartTime)/1000);
  let correct=0;
  const wrong=[];

  let html="";

  currentQuiz.forEach((q,idx)=>{
    const sel=document.querySelector(`input[name="q${idx}"]:checked`);
    const u = sel ? Number(sel.value) : null;

    const ok = (u === q.answer);
    if(ok) correct++;
    else wrong.push(q);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx+1} (${q.id})</b><br>
        선택: ${u===null ? "무응답" : `${String.fromCharCode(65+u)}. ${q.options[u]}`}<br>
        정답:
        <span style="color:${ok?"#16a34a":"#dc2626"}">
          ${String.fromCharCode(65+q.answer)}. ${q.options[q.answer]}
        </span>
        <div class="explanation">${q.explanation||""}</div>
      </div>
    `;
  });

  const pct = Math.round(correct/currentQuiz.length*100);

  document.getElementById("resultBox").innerHTML = `
    <h3>점수: ${correct}/${currentQuiz.length} (${pct}%)</h3>
    <div style="font-size:12px;color:#666;">
      소요시간: ${duration}s ${auto?"(자동 제출)":""}
    </div>
    ${html}
  `;

  document.getElementById("submitBtn").disabled=true;

  /* 오답 기록 */
  if(wrong.length){
    const notes=loadWrongNotes();
    const now=new Date().toLocaleString();

    wrong.forEach(q=>{
      const ex=notes.find(n=>n.id===q.id);
      if(ex){
        ex.missCount++;
        ex.lastDate = now;
      } else {
        notes.push({
          id:q.id, text:q.text, chapter:q.chapter, type:q.type,
          missCount:1, lastDate:now
        });
      }
    });

    saveWrongNotes(notes);
    renderWrongNotes();
  }

  /* 점수 저장 */
  const hist=loadScoreHistory();
  hist.push({
    date:new Date().toLocaleString(),
    mode:document.getElementById("modeDesc").textContent,
    total:currentQuiz.length,
    correct,
    durationSec:duration
  });
  saveScoreHistory(hist);
  renderScoreHistory();
}

/******************************************************************
 * 12. 초기화
 ******************************************************************/
function resetQuiz(){
  stopTimer();
  quizStarted=false;
  currentQuiz=[];
  document.getElementById("quizBox").innerHTML="";
  document.getElementById("resultBox").innerHTML="";
  document.getElementById("modeDesc").textContent="";
  document.getElementById("timer").textContent="Timer: OFF";

  document.getElementById("startBtn").disabled=false;
  document.getElementById("submitBtn").disabled=true;
  document.getElementById("resetBtn").disabled=true;
}

/******************************************************************
 * 13. 문제 추가 폼
 ******************************************************************/
function setupAddQuestionForm(){
  const f=document.getElementById("addQuestionForm");

  f.addEventListener("submit", e=>{
    e.preventDefault();

    const q={
      id:document.getElementById("addId").value.trim(),
      chapter:document.getElementById("addChapter").value,
      type:document.getElementById("addType").value,
      text:document.getElementById("addText").value.trim(),
      options:[
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim()
      ],
      answer:Number(document.getElementById("addAnswer").value),
      explanation:document.getElementById("addExplanation").value.trim()
    };

    if(!q.id || !q.text || q.options.some(o=>!o) || q.answer<0 || q.answer>3){
      alert("필드를 모두 입력하세요.");
      return;
    }

    const custom = loadCustomQuestions();
    if(custom.some(c=>c.id===q.id) || BASE_QUESTIONS.some(b=>b.id===q.id)){
      alert("ID 중복입니다.");
      return;
    }

    custom.push(q);
    saveCustomQuestions(custom);
    refreshChapterDropdown();

    alert("문제 추가 완료!");
    f.reset();
  });
}

/******************************************************************
 * 14. JSON 문제 업로드
 ******************************************************************/
function setupUploadQuestions(){
  const input=document.getElementById("uploadFileInput");
  const btn=document.getElementById("uploadFileBtn");

  btn.addEventListener("click", ()=>{
    const file=input.files?.[0];
    if(!file){ alert("파일을 선택하세요."); return; }

    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const arr=JSON.parse(e.target.result);
        if(!Array.isArray(arr)){ alert("JSON 배열 형식이 아닙니다."); return; }

        const custom=loadCustomQuestions();
        const existing=new Set([
          ...BASE_QUESTIONS.map(q=>q.id),
          ...custom.map(q=>q.id)
        ]);

        const valid=[];
        arr.forEach((q,i)=>{
          if(!q.id || !q.chapter || !q.text ||
             !Array.isArray(q.options) || q.options.length!==4 ||
             typeof q.answer!=="number"){
            console.warn("제외", i, q);
            return;
          }

          if(!("explanation" in q)) q.explanation="";

          if(!existing.has(q.id)) valid.push(q);
        });

        if(!valid.length){ alert("추가할 문제가 없습니다."); return; }

        saveCustomQuestions(custom.concat(valid));
        refreshChapterDropdown();

        alert(`${valid.length}문제 추가 완료!`);
      }
      catch(err){
        alert("JSON 파싱 오류");
      }
    };

    reader.readAsText(file);
  });
}

/******************************************************************
 * 15. 사용자 문제 관리
 ******************************************************************/
function setupCustomManagement(){
  document.getElementById("clearCustomBtn").addEventListener("click", ()=>{
    if(!confirm("사용자 문제 전체 삭제?")) return;
    saveCustomQuestions([]);
    refreshChapterDropdown();
  });

  document.getElementById("exportCustomBtn").addEventListener("click", ()=>{
    const data=loadCustomQuestions();
    if(!data.length){
      alert("저장된 사용자 문제가 없습니다.");
      return;
    }

    const blob=new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url=URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url;
    a.download="cre_custom_questions.json";
    a.click();

    URL.revokeObjectURL(url);
  });
}

/******************************************************************
 * 16. 비밀번호 게이트
 ******************************************************************/
function setupGate(){
  const ov=document.getElementById("gateOverlay");
  const input=document.getElementById("gatePassword");
  const btn=document.getElementById("gateBtn");
  const app=document.getElementById("appContainer");
  const msg=document.getElementById("gateMessage");

  function enter(){
    if(input.value===APP_PASSWORD){
      ov.style.display="none";
      app.style.display="block";

      renderWrongNotes();
      renderScoreHistory();
      refreshChapterDropdown();
    } else {
      msg.textContent="비밀번호가 올바르지 않습니다.";
    }
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter") enter();
  });
}

/******************************************************************
 * 17. 초기 실행
 ******************************************************************/
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("submitBtn").addEventListener("click", ()=>submitQuiz(false));
document.getElementById("resetBtn").addEventListener("click", resetQuiz);

setupAddQuestionForm();
setupUploadQuestions();
setupCustomManagement();
setupGate();
</script>
</body>
</html>  

