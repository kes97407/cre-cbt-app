<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT</title>

<!-- CSS ì˜ì—­ â€” ë©”ì‹œì§€ â‘¡ì—ì„œ ì´ê³³ì— ë¶™ì—¬ë„£ìŒ -->
<style>
/* === CSS WILL BE INSERTED HERE (MESSAGE â‘¡) === */
  body {
  font-family: Arial, system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background:#f2f4f7;
}

/* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
.container {
  max-width: 1100px;
  margin: 20px auto;
  background:#fff;
  border-radius:10px;
  padding:20px 24px 40px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  display:none;
}

h1 { margin-top:0; }

/* ìƒë‹¨ ì»¨íŠ¸ë¡¤ë°•ìŠ¤ */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:16px;
  padding:12px;
  background:#f7f9fc;
  border-radius:8px;
}

.controls > div { min-width: 180px; }

label {
  font-size:14px;
  font-weight:600;
  display:block;
  margin-bottom:4px;
}

select,
input[type="number"],
input[type="text"],
textarea {
  width:100%;
  padding:6px 8px;
  font-size:14px;
  box-sizing:border-box;
}

button {
  padding:8px 14px;
  font-size:14px;
  cursor:pointer;
  border-radius:6px;
  border:1px solid #1f6feb;
  background:#1f6feb;
  color:#fff;
}

button.secondary {
  background:#fff;
  color:#1f2933;
  border-color:#cbd2e1;
}

button.danger {
  background:#e11d48;
  border-color:#e11d48;
  color:#fff;
}

button:disabled {
  opacity:0.6;
  cursor:not-allowed;
}

/* íƒ€ì´ë¨¸ */
#timer {
  font-size:18px;
  font-weight:bold;
  color:#e11d48;
}

#modeDesc {
  font-size:13px;
  color:#4b5563;
  margin-top:4px;
}

/* ë¬¸ì œ ë¸”ë¡ */
.question-block {
  margin-bottom:20px;
  padding-bottom:12px;
  border-bottom:1px solid #e5e7eb;
}

.question-title {
  font-weight:bold;
  margin-bottom:8px;
}

.meta {
  font-size:12px;
  color:#6b7280;
  margin-bottom:4px;
}

.option { margin:4px 0; font-size:14px; }

/* ê²°ê³¼ ë°•ìŠ¤ */
#resultBox {
  margin-top:24px;
  padding:16px;
  border-radius:8px;
  background:#ecfeff;
  border:1px solid #7dd3fc;
}

#resultBox h3 { margin-top:0; }

.explanation {
  font-size:13px;
  margin-top:4px;
  color:#334155;
}

/* íŒ¨ë„ë“¤ */
.panel-row {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:20px;
}

.panel {
  flex:1;
  min-width:260px;
  background:#f9fafb;
  border-radius:8px;
  padding:10px 12px;
  border:1px solid #e5e7eb;
  max-height:300px;
  overflow:auto;
}

.panel h3 {
  margin-top:0;
  font-size:15px;
}

.note-item,
.score-item {
  font-size:12px;
  margin-bottom:6px;
  border-bottom:1px dashed #e5e7eb;
  padding-bottom:4px;
}

/* íƒœê·¸ */
.tag {
  display:inline-block;
  font-size:11px;
  padding:1px 6px;
  border-radius:999px;
  margin-left:4px;
  background:#e5e7eb;
}

.tag.A { background:#dbeafe; }
.tag.C { background:#fef3c7; }

/* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ */
#gateOverlay {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#gateBox {
  background:#f9fafb;
  border-radius:12px;
  padding:24px 26px;
  width:320px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

#gateBox h2 { margin-top:0; margin-bottom:12px; }

#gateMessage {
  font-size:12px;
  color:#dc2626;
  height:16px;
  margin-top:6px;
}

#gateBox input {
  width:100%;
  padding:8px;
  margin-top:8px;
  box-sizing:border-box;
}

#gateBox button { margin-top:12px; width:100%; }

/* ë¬¸ì œì¶”ê°€ */
#addQuestionForm textarea { height:60px; resize:vertical; }

#addQuestionForm .small-input {
  width:60px;
  display:inline-block;
}

</style>

</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
    <p style="font-size:11px;color:#6b7280;margin-top:12px;">
      * ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ê°„ë‹¨í•œ ì¶œì… í†µì œìš©ì…ë‹ˆë‹¤. ë³´ì•ˆìš©ìœ¼ë¡œëŠ” ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    ì±•í„° / ìœ í˜• / ë¬¸ì œ ìˆ˜ / ì‹œê°„ / ì¶œì œ ëª¨ë“œ ì„ íƒ í›„ <b>ì‹œí—˜ ì‹œì‘</b>ì„ ëˆŒëŸ¬ ì—°ìŠµí•˜ì„¸ìš”.<br/>
    ì˜¤ë‹µê³¼ ì ìˆ˜ëŠ” ë¸Œë¼ìš°ì €(LocalStorage)ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
  </p>

  <!-- ìƒë‹¨ ì˜µì…˜ -->
  <div class="controls">

    <div>
      <label>ì±•í„° ì„ íƒ</label>
      <select id="chapterSelect">
        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
      </select>
    </div>

    <div>
      <label>ë¬¸ì œ ìœ í˜•</label>
      <select id="typeSelect">
        <option value="all">A+C ì „ì²´</option>
        <option value="A">A-type (ê°œë…í˜•)</option>
        <option value="C">C-type (ê³„ì‚°/ìƒí™©í˜•)</option>
      </select>
    </div>

    <div>
      <label>ì¶œì œ ë¬¸ì œ ìˆ˜</label>
      <input id="countInput" type="number" min="1" max="200" value="10" />
    </div>

    <div>
      <label>íƒ€ì´ë¨¸ (ë¶„)</label>
      <input id="timerInput" type="number" min="0" max="240" value="60" />
    </div>

    <div>
      <label>ì¶œì œ ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜ ëª¨ë“œ</option>
        <option value="wrong">ì˜¤ë‹µë§Œ ëª¨ë“œ</option>
        <option value="weak">ì•½ì  ì±•í„° ëª¨ë“œ</option>
      </select>
    </div>

    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
      <button id="submitBtn" class="secondary" disabled>ì œì¶œ</button>
      <button id="resetBtn" class="secondary" disabled>ì´ˆê¸°í™”</button>
    </div>

    <div style="margin-left:auto; text-align:right;">
      <div id="timer">Timer: OFF</div>
      <div id="modeDesc"></div>
    </div>

  </div>

  <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
  <div id="quizBox"></div>

  <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
  <div id="resultBox"></div>

  <!-- íŒ¨ë„ ì˜ì—­ -->
  <div class="panel-row">

    <!-- ì˜¤ë‹µë…¸íŠ¸ -->
    <div class="panel">
      <h3>ğŸ“’ ì˜¤ë‹µë…¸íŠ¸ (ìë™ ì €ì¥)</h3>
      <div id="wrongNotesBox"></div>
      <button class="secondary" onclick="clearWrongNotes()">ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
    </div>

    <!-- ì ìˆ˜ ê¸°ë¡ -->
    <div class="panel">
      <h3>ğŸ“Š ì ìˆ˜ ê¸°ë¡ (LocalStorage)</h3>
      <div id="scoreHistoryBox"></div>
      <button class="secondary" onclick="clearScoreHistory()">ì ìˆ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <!-- ë¬¸ì œ ì¶”ê°€ íŒ¨ë„ -->
    <div class="panel">
      <h3>â• ë¬¸ì œ ì¶”ê°€ (ë¸Œë¼ìš°ì €ì— ì €ì¥)</h3>
      <form id="addQuestionForm">
        <label>ë¬¸ì œ ID</label>
        <input type="text" id="addId" placeholder="ì˜ˆ: Q100-1" required />

        <label>ì±•í„°</label>
        <select id="addChapter"></select>

        <label>ìœ í˜•</label>
        <select id="addType">
          <option value="A">A-type</option>
          <option value="C">C-type</option>
        </select>

        <label>ë¬¸ì œ ë‚´ìš©</label>
        <textarea id="addText" required></textarea>

        <label>ë³´ê¸° A/B/C/D</label>
        <input type="text" id="addOpA" placeholder="ë³´ê¸° A" required />
        <input type="text" id="addOpB" placeholder="ë³´ê¸° B" required />
        <input type="text" id="addOpC" placeholder="ë³´ê¸° C" required />
        <input type="text" id="addOpD" placeholder="ë³´ê¸° D" required />

        <label>ì •ë‹µ (0=A, 1=B, 2=C, 3=D)</label>
        <input type="number" id="addAnswer" min="0" max="3" class="small-input" value="0" required />

        <label>í•´ì„¤</label>
        <textarea id="addExplanation" required></textarea>

        <button type="submit" class="secondary" style="margin-top:8px;">ë¬¸ì œ ì¶”ê°€</button>
      </form>

      <hr style="margin:10px 0;">
      <h4>ğŸ“ JSON ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ</h4>
      <input type="file" id="uploadFileInput" accept=".json" />
      <button class="secondary" id="uploadFileBtn" style="margin-top:6px;">íŒŒì¼ì—ì„œ ë¬¸ì œ ì¶”ê°€</button>

      <p style="font-size:11px;color:#6b7280;">
        JSON ë°°ì—´ í˜•ì‹: { id, chapter, type, text, options[4], answer, explanation }
      </p>

      <hr style="margin:10px 0;">
      <h4>ğŸ“¦ ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬</h4>
      <button class="danger" id="clearCustomBtn">ì‚¬ìš©ì ì¶”ê°€ ë¬¸ì œ ì‚­ì œ</button>
      <button class="secondary" id="exportCustomBtn" style="margin-top:4px;">ì‚¬ìš©ì ë¬¸ì œ JSON ë‹¤ìš´ë¡œë“œ</button>
    </div>

  </div>

</div>

<!-- JS ì˜ì—­ â€” ë©”ì‹œì§€ â‘¢ì—ì„œ ì´ê³³ì— ë¶™ì—¬ë„£ìŒ -->
<script>
/* === JAVASCRIPT WILL BE INSERTED HERE (MESSAGE â‘¢) === */
/***********************************************************
 * 0. ì„¤ì •
 ***********************************************************/
const APP_PASSWORD = "cre2025";

/***********************************************************
 * 1. ê¸°ë³¸ ë¬¸ì œ ë°ì´í„°
 ***********************************************************/
const BASE_QUESTIONS = [
  // ì±•í„° 4 - Statistical Concepts
  { id:"Q1", chapter:"ì±•í„° 4 - Statistical Concepts", type:"C",
    text:"Exponential ë¶„í¬ì—ì„œ MTBF = 800ì‹œê°„ì¼ ë•Œ R(400)ì€?",
    options:["0.50","0.61","0.37","0.80"], answer:1,
    explanation:"R=exp(-0.5)=0.606" },

  { id:"Q2", chapter:"ì±•í„° 4 - Statistical Concepts", type:"C",
    text:"Exponential ì‹œí—˜ T=4000h, r=3, 90% MTBF í•˜í•œ?",
    options:[
      "2T / Ï‡Â²(2r; lower 0.10)",
      "2T / Ï‡Â²(2r; upper 0.10)",
      "T / r",
      "T / (r-1)"
    ], answer:1,
    explanation:"Lower LCB = 2T / Ï‡Â²(upper Î±)" },

  { id:"Q3", chapter:"ì±•í„° 4 - Statistical Concepts", type:"C",
    text:"ì •ê·œ(50,10)ì—ì„œ 40 ì´í•˜ í™•ë¥ ?",
    options:["0.16","0.30","0.50","0.84"], answer:0,
    explanation:"Z=-1 â†’ 0.1587" },

  { id:"Q4", chapter:"ì±•í„° 4 - Statistical Concepts", type:"A",
    text:"Exponential R(MTBF) ê°’?",
    options:["0.50","0.37","0.63","0.90"], answer:1,
    explanation:"exp(-1)=0.37" },

  { id:"Q5", chapter:"ì±•í„° 4 - Statistical Concepts", type:"A",
    text:"Weibull Î²>1 ì˜ë¯¸?",
    options:["ì´ˆê¸°ê³ ì¥","ë§ˆëª¨ê³ ì¥","ê³ ì¥ë¥  ì¼ì •","ë¬´ì‘ìœ„"], answer:1,
    explanation:"Î²>1 = wear-out" },

  // ì±•í„° 7 - Testing and Modeling
  { id:"Q6", chapter:"ì±•í„° 7 - Testing and Modeling", type:"A",
    text:"ALT ëª©ì ?",
    options:["ì„¤ê³„í•œê³„","ë‹¨ê¸°ê°„â†’ìˆ˜ëª…ì˜ˆì¸¡","Cpk ê°œì„ ","íŒŒê´´ì‹œí—˜"],
    answer:1, explanation:"ë‹¨ê¸°ê°„ ìˆ˜ëª… ì˜ˆì¸¡" },

  { id:"Q7", chapter:"ì±•í„° 7 - Testing and Modeling", type:"A",
    text:"Peck ëª¨ë¸?",
    options:["ì˜¨ë„","ìŠµë„","ì˜¨ë„+ìŠµë„","ì „ì••+ì§„ë™"],
    answer:2, explanation:"ì˜¨ë„+ìŠµë„" },

  { id:"Q8", chapter:"ì±•í„° 7 - Testing and Modeling", type:"A",
    text:"Step-stress?",
    options:["ìœ ì§€","ë‹¨ê³„ì  ì¦ê°€","ë‹¨ê³„ì  ê°ì†Œ","ë¬´ì‘ìœ„"],
    answer:1, explanation:"ìŠ¤íŠ¸ë ˆìŠ¤ ë‹¨ê³„ ì¦ê°€" },

  { id:"Q9", chapter:"ì±•í„° 7 - Testing and Modeling", type:"C",
    text:"ë³‘ë ¬ 0.7/0.8/0.9 ì‹œìŠ¤í…œ?",
    options:["0.90","0.97","0.50","0.80"], answer:1,
    explanation:"1-(0.3)(0.2)(0.1)=0.994" },

  { id:"Q10", chapter:"ì±•í„° 7 - Testing and Modeling", type:"C",
    text:"Perfect standby Active=0.9, Standby=0.8",
    options:["0.90","0.92","0.98","0.99"], answer:2,
    explanation:"0.9+0.1*0.8=0.98" },

  // ì±•í„° 3 - Risk Management
  { id:"Q11", chapter:"ì±•í„° 3 - Risk Management", type:"A",
    text:"Common Cause Failure?",
    options:["ë…ë¦½ê³ ì¥","ë™ì¼ì›ì¸ ë³‘ë ¬ê³ ì¥","í™˜ê²½ë¬´ê´€","ìˆ˜ë¦¬ê³ ì¥"],
    answer:1, explanation:"ë™ì¼ì›ì¸" },

  { id:"Q12", chapter:"ì±•í„° 3 - Risk Management", type:"A",
    text:"FTA ì¥ì ?",
    options:["ëª¨ë“ ê³ ì¥","ì¶”ì„¸ë¶„ì„","Top event ì¤‘ì‹¬","ìƒí˜¸ì‘ìš©"],
    answer:2, explanation:"Top event ë¶„ì„" },

  // ì±•í„° 8 - Reliability Designs
  { id:"Q13", chapter:"ì±•í„° 8 - Reliability Designs", type:"A",
    text:"DOEì˜ ë¸”ë¡?",
    options:["ìš”ì¸ìˆ˜ì¤€","ê· ì¼ê·¸ë£¹","ë°˜ë³µ","ìƒí˜¸ì‘ìš©"],
    answer:1, explanation:"ê· ì¼ì§‘ë‹¨" },

  { id:"Q14", chapter:"ì±•í„° 8 - Reliability Designs", type:"A",
    text:"Taguchi Loss?",
    options:["ê·œê²©ë‚´0","ì œê³±ë¹„ë¡€","ì„ í˜•","ìƒìˆ˜"],
    answer:1, explanation:"(y-T)^2" },

  { id:"Q15", chapter:"ì±•í„° 8 - Reliability Designs", type:"A",
    text:"Robust Design ëª©ì ?",
    options:["ë¹„ìš©â†“","Cpkâ†‘","Noise ë¯¼ê°ë„â†“","ì‹œí—˜ë‹¨ì¶•"],
    answer:2, explanation:"ì¡ìŒ ë¯¼ê°ë„ ê°ì†Œ" },

  // ì±•í„° 9 - Maintainability
  { id:"Q16", chapter:"ì±•í„° 9 - Maintainability", type:"A",
    text:"RCM ëª©ì ?",
    options:["ë¹„ìš©â†“","ê°€ìš©ì„±ì¶”ì •","ì¤‘ìš” ê³ ì¥ëª¨ë“œ ì˜ˆë°©ë³´ì „","ë™ì¼ì£¼ê¸°êµì²´"],
    answer:2, explanation:"ì¤‘ìš”ëª¨ë“œ ì˜ˆë°©" },

  { id:"Q17", chapter:"ì±•í„° 9 - Maintainability", type:"C",
    text:"MTBM=1700h MDT=34h Ao?",
    options:["0.90","0.95","0.98","0.99"],
    answer:2, explanation:"1700/(1734)=0.981" },
];

/***********************************************************
 * 2. LocalStorage Helper
 ***********************************************************/
const loadWrongNotes = () => JSON.parse(localStorage.getItem("creWrongNotes")||"[]");
const saveWrongNotes = v => localStorage.setItem("creWrongNotes", JSON.stringify(v));

const loadScoreHistory = () => JSON.parse(localStorage.getItem("creScoreHistory")||"[]");
const saveScoreHistory = v => localStorage.setItem("creScoreHistory", JSON.stringify(v));

const loadCustomQuestions = () => JSON.parse(localStorage.getItem("creCustomQuestions")||"[]");
const saveCustomQuestions = v => localStorage.setItem("creCustomQuestions", JSON.stringify(v));

/***********************************************************
 * 3. ë™ì  ì±•í„° ìë™ ìƒì„±
 ***********************************************************/
function refreshChapterDropdown() {
  const chapterSelect = document.getElementById("chapterSelect");
  const addChapter = document.getElementById("addChapter");

  const all = BASE_QUESTIONS.concat(loadCustomQuestions());
  const chapters = new Set(["ì „ì²´"]);

  all.forEach(q => chapters.add(q.chapter));

  chapterSelect.innerHTML = "";
  addChapter.innerHTML = "";

  chapters.forEach(ch => {
    chapterSelect.innerHTML += `<option value="${ch==='ì „ì²´'?'all':ch}">${ch}</option>`;
    if (ch !== "ì „ì²´") addChapter.innerHTML += `<option value="${ch}">${ch}</option>`;
  });
}

/***********************************************************
 * 4. í•©ì³ì§„ ë¬¸ì œ ëª©ë¡
 ***********************************************************/
const getAllQuestions = () => BASE_QUESTIONS.concat(loadCustomQuestions());

/***********************************************************
 * 5. ì˜¤ë‹µ/ì ìˆ˜
 ***********************************************************/
function renderWrongNotes(){
  const notes = loadWrongNotes();
  const box = document.getElementById("wrongNotesBox");

  if (!notes.length){
    box.innerHTML = "<div style='font-size:12px;color:#6b7280;'>ì˜¤ë‹µ ì—†ìŒ</div>";
    return;
  }

  box.innerHTML = notes.map(n => `
    <div class="note-item">
      <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
      <div>${n.text}</div>
      <div style="font-size:11px;color:#6b7280;">
        ${n.chapter} Â· ${n.missCount}íšŒ Â· ${n.lastDate}
      </div>
    </div>
  `).join("");
}

function renderScoreHistory(){
  const hist = loadScoreHistory();
  const box = document.getElementById("scoreHistoryBox");

  if (!hist.length){
    box.innerHTML = "<div style='font-size:12px;color:#6b7280;'>ê¸°ë¡ ì—†ìŒ</div>";
    return;
  }

  box.innerHTML = hist.slice().reverse().map(h => `
    <div class="score-item">
      <b>${h.date}</b> â€” ${h.correct}/${h.total} (${Math.round(h.correct/h.total*100)}%)
      <div style="font-size:11px;color:#6b7280;">${h.mode} Â· ${h.durationSec}s</div>
    </div>
  `).join("");
}
/***********************************************************
 * ì˜¤ë‹µë…¸íŠ¸ / ì ìˆ˜ ê¸°ë¡ ì´ˆê¸°í™” í•¨ìˆ˜ (ì¶”ê°€)
 ***********************************************************/
function clearWrongNotes() {
  if (!confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  saveWrongNotes([]);
  renderWrongNotes();
}

function clearScoreHistory() {
  if (!confirm("ì ìˆ˜ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  saveScoreHistory([]);
  renderScoreHistory();
}

/***********************************************************
 * 6. íƒ€ì´ë¨¸
 ***********************************************************/
let timerId=null, timerSeconds=0, quizStarted=false, quizStartTime=null, currentQuiz=[];
/***********************************************************
 * íƒ€ì´ë¨¸ ì¤‘ì§€ í•¨ìˆ˜ (ì¶”ê°€)
 ***********************************************************/
function stopTimer() {
  if (timerId !== null) {
    clearInterval(timerId);
    timerId = null;
  }
}

function updateTimerDisplay(){
  const el = document.getElementById("timer");
  if (timerSeconds<=0){ el.textContent="Timer: OFF"; return; }
  const m = String(Math.floor(timerSeconds/60)).padStart(2,"0");
  const s = String(timerSeconds%60).padStart(2,"0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startTimer(sec){
  clearInterval(timerId);
  timerSeconds = sec;
  updateTimerDisplay();

  if(sec<=0) return;

  timerId = setInterval(()=>{
    timerSeconds--;
    updateTimerDisplay();
    if(timerSeconds<=0){
      clearInterval(timerId);
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œë©ë‹ˆë‹¤.");
      submitQuiz(true);
    }
  },1000);
}

/***********************************************************
 * 7. ë¬¸ì œ ì„ê¸°
 ***********************************************************/
const shuffleArray = arr => {
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
};

/***********************************************************
 * 8. ì‹œí—˜ í‘œì‹œ
 ***********************************************************/
function renderQuiz(){
  const box=document.getElementById("quizBox");
  box.innerHTML = "";

  currentQuiz.forEach((q, idx)=>{
    let html = `
      <div class="question-block">
        <div class="question-title">Q${idx+1}. ${q.text}</div>
        <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
    `;

    q.options.forEach((op,j)=>{
      html += `
        <div class="option">
          <label>
            <input type="radio" name="q${idx}" value="${j}" />
            ${String.fromCharCode(65+j)}. ${op}
          </label>
        </div>`;
    });

    html += "</div>";
    box.innerHTML += html;
  });
}

/***********************************************************
 * 9. ì¶œì œ ëª¨ë“œ (normal/wrong/weak)
 ***********************************************************/
function buildQuestionPool(){
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode=document.getElementById("modeSelect").value;

  const all=getAllQuestions();
  const notes=loadWrongNotes();

  let pool=[];

  if(mode==="normal"){
    pool = all.filter(q =>
      (ch==="all" || q.chapter===ch) &&
      (tp==="all" || q.type===tp)
    );
  }

  else if(mode==="wrong"){
    const wrongIds = new Set(notes.map(n=>n.id));
    pool = all.filter(q =>
      wrongIds.has(q.id) &&
      (ch==="all" || q.chapter===ch) &&
      (tp==="all" || q.type===tp)
    );
  }

  else if(mode==="weak"){
    if(!notes.length){
      alert("ì˜¤ë‹µë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return { pool:[], autoChapter:null };
    }
    const counts={};
    notes.forEach(n=>counts[n.chapter]=(counts[n.chapter]||0)+n.missCount);

    let weak=null, max=-1;
    for(const c in counts){
      if(counts[c]>max){ weak=c; max=counts[c]; }
    }

    pool = all.filter(q =>
      q.chapter===weak &&
      (tp==="all" || q.type===tp)
    );

    return { pool, autoChapter:weak };
  }

  return { pool, autoChapter:null };
}

/***********************************************************
 * 10. ì‹œí—˜ ì‹œì‘
 ***********************************************************/
function startQuiz(){
  const cnt = Number(document.getElementById("countInput").value);
  const tm = Number(document.getElementById("timerInput").value);
  const mode = document.getElementById("modeSelect").value;

  const { pool, autoChapter } = buildQuestionPool();
  if(!pool.length){
    alert("ì¶œì œ ê°€ëŠ¥í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  currentQuiz = shuffleArray(pool).slice(0, cnt||pool.length);
  renderQuiz();

  quizStarted = true;
  quizStartTime = Date.now();

  document.getElementById("resultBox").innerHTML="";
  document.getElementById("startBtn").disabled=true;
  document.getElementById("submitBtn").disabled=false;
  document.getElementById("resetBtn").disabled=false;

  const desc=[];
  desc.push(mode==="normal" ? "ì¼ë°˜" :
            mode==="wrong"  ? "ì˜¤ë‹µë§Œ" :
            "ì•½ì  ì±•í„°");

  if(mode==="weak" && autoChapter)
    desc.push(`ì±•í„°=${autoChapter}`);
  else {
    const ch=document.getElementById("chapterSelect").value;
    desc.push(ch==="all" ? "ì „ì²´" : `ì±•í„°=${ch}`);
  }

  const tp=document.getElementById("typeSelect").value;
  desc.push(tp==="all" ? "A+C" : `ìœ í˜•=${tp}`);
  desc.push(`ë¬¸ì œ=${currentQuiz.length}`);
  document.getElementById("modeDesc").textContent = desc.join(" / ");

  startTimer(tm>0 ? tm*60 : 0);
}

/***********************************************************
 * 11. ì œì¶œ/ì±„ì 
 ***********************************************************/
function submitQuiz(auto=false){
  if(!quizStarted) return;
  quizStarted=false;
  stopTimer();

  const duration=Math.round((Date.now()-quizStartTime)/1000);
  let correct=0;
  let html="";
  const wrong=[];

  currentQuiz.forEach((q,idx)=>{
    const sel=document.querySelector(`input[name="q${idx}"]:checked`);
    const u=sel ? Number(sel.value) : null;
    const ok=u===q.answer;

    if(ok) correct++;
    else wrong.push(q);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx+1} (${q.id})</b><br>
        ì„ íƒ: ${u===null?"ë¬´ì‘ë‹µ":`${String.fromCharCode(65+u)}. ${q.options[u]}`}<br>
        ì •ë‹µ: <span style="color:${ok?"#16a34a":"#dc2626"}">
          ${String.fromCharCode(65+q.answer)}. ${q.options[q.answer]}
        </span>
        <div class="explanation">${q.explanation||""}</div>
      </div>`;
  });

  const pct=Math.round(correct/currentQuiz.length*100);

  document.getElementById("resultBox").innerHTML=`
    <h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>
    <div style="font-size:12px;color:#6b7280;">ì†Œìš” ${duration}s ${auto?"(ìë™ ì œì¶œ)":""}</div>
    ${html}
  `;

  document.getElementById("submitBtn").disabled=true;

  // ì˜¤ë‹µ ê¸°ë¡
  if(wrong.length){
    const notes=loadWrongNotes();
    const now=new Date().toLocaleString();

    wrong.forEach(q=>{
      const ex=notes.find(n=>n.id===q.id);
      if(ex){ ex.missCount++; ex.lastDate=now; }
      else notes.push({
        id:q.id, text:q.text, chapter:q.chapter,
        type:q.type, missCount:1, lastDate:now
      });
    });

    saveWrongNotes(notes);
    renderWrongNotes();
  }

  const hist=loadScoreHistory();
  hist.push({
    date:new Date().toLocaleString(),
    mode:document.getElementById("modeDesc").textContent,
    total:currentQuiz.length,
    correct,
    durationSec:duration
  });
  saveScoreHistory(hist);
  renderScoreHistory();
}

/***********************************************************
 * 12. ì´ˆê¸°í™”
 ***********************************************************/
function resetQuiz(){
  stopTimer();
  quizStarted=false;
  currentQuiz=[];
  document.getElementById("quizBox").innerHTML="";
  document.getElementById("resultBox").innerHTML="";
  document.getElementById("modeDesc").textContent="";
  document.getElementById("timer").textContent="Timer: OFF";

  document.getElementById("startBtn").disabled=false;
  document.getElementById("submitBtn").disabled=true;
  document.getElementById("resetBtn").disabled=true;
}

/***********************************************************
 * 13. ë¬¸ì œ ì¶”ê°€ í¼ (ì„¤ëª… ì—†ì–´ë„ í—ˆìš©)
 ***********************************************************/
function setupAddQuestionForm(){
  const form=document.getElementById("addQuestionForm");

  form.addEventListener("submit", e=>{
    e.preventDefault();

    const q={
      id:document.getElementById("addId").value.trim(),
      chapter:document.getElementById("addChapter").value,
      type:document.getElementById("addType").value,
      text:document.getElementById("addText").value.trim(),
      options:[
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim(),
      ],
      answer:Number(document.getElementById("addAnswer").value),
      explanation:document.getElementById("addExplanation").value.trim() || ""
    };

    if(!q.id || !q.text || q.options.some(o=>!o) ||
       q.answer<0 || q.answer>3){
      alert("ëª¨ë“  í•„ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
      return;
    }

    const custom=loadCustomQuestions();
    if(custom.some(c=>c.id===q.id) || BASE_QUESTIONS.some(b=>b.id===q.id)){
      alert("ID ì¤‘ë³µì…ë‹ˆë‹¤.");
      return;
    }

    custom.push(q);
    saveCustomQuestions(custom);
    refreshChapterDropdown();

    alert("ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!");
    form.reset();
  });
}

/***********************************************************
 * 14. JSON ë¬¸ì œ ì—…ë¡œë“œ (ì„¤ëª… ì—†ì–´ë„ OK)
 ***********************************************************/
function setupUploadQuestions(){
  const input=document.getElementById("uploadFileInput");
  const btn=document.getElementById("uploadFileBtn");

  btn.addEventListener("click", ()=>{
    const file=input.files?.[0];
    if(!file){ alert("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }

    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const arr=JSON.parse(e.target.result);
        if(!Array.isArray(arr)){ alert("JSON ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤."); return; }

        const custom=loadCustomQuestions();
        const allIds=new Set([
          ...BASE_QUESTIONS.map(q=>q.id),
          ...custom.map(q=>q.id)
        ]);

        const valid=[];
        arr.forEach((q,idx)=>{
          if(!q.id || !q.chapter || !q.text ||
             !Array.isArray(q.options) || q.options.length!==4 ||
             typeof q.answer!=="number"){
            console.warn("ì œì™¸:", idx, q);
            return;
          }

          // explanation ì—†ìœ¼ë©´ ìë™ ìƒì„±
          if(!("explanation" in q) || q.explanation===null)
            q.explanation = "";

          if(!allIds.has(q.id))
            valid.push(q);
        });

        if(!valid.length){ alert("ì¶”ê°€í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        saveCustomQuestions(custom.concat(valid));
        refreshChapterDropdown();
        alert(`${valid.length}ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!`);
      }
      catch(err){
        alert("JSON íŒŒì‹± ì˜¤ë¥˜");
      }
    };

    reader.readAsText(file);
  });
}

/***********************************************************
 * 15. ì‚¬ìš©ì ë¬¸ì œ Export/ì‚­ì œ
 ***********************************************************/
function setupCustomManagement(){
  const clear=document.getElementById("clearCustomBtn");
  const exp=document.getElementById("exportCustomBtn");

  clear.addEventListener("click", ()=>{
    if(confirm("ì‚¬ìš©ì ë¬¸ì œ ì „ì²´ ì‚­ì œ?")){
      saveCustomQuestions([]);
      refreshChapterDropdown();
    }
  });

  exp.addEventListener("click", ()=>{
    const data=loadCustomQuestions();
    if(!data.length){ alert("ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

    const blob=new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url=URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url;
    a.download="cre_custom_questions.json";
    a.click();

    URL.revokeObjectURL(url);
  });
}

/***********************************************************
 * 16. ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
 ***********************************************************/
function setupGate(){
  const overlay=document.getElementById("gateOverlay");
  const input=document.getElementById("gatePassword");
  const btn=document.getElementById("gateBtn");
  const msg=document.getElementById("gateMessage");
  const app=document.getElementById("appContainer");

  function enter(){
    if(input.value===APP_PASSWORD){
      overlay.style.display="none";
      app.style.display="block";
      renderWrongNotes();
      renderScoreHistory();
      refreshChapterDropdown();
    } else {
      msg.textContent="ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter") enter();
  });
}

/***********************************************************
 * 17. ì´ˆê¸° ì‹¤í–‰
 ***********************************************************/
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("submitBtn").addEventListener("click", ()=>submitQuiz(false));
document.getElementById("resetBtn").addEventListener("click", resetQuiz);

setupAddQuestionForm();
setupUploadQuestions();
setupCustomManagement();
setupGate();

</script>

</body>
</html>



