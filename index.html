<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT</title>

<!-- CSS ì˜ì—­ â€” ë©”ì‹œì§€ â‘¡ì—ì„œ ì´ê³³ì— ë¶™ì—¬ë„£ìŒ -->
<style>
/* === CSS WILL BE INSERTED HERE (MESSAGE â‘¡) === */
  body {
  font-family: Arial, system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background:#f2f4f7;
}

/* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
.container {
  max-width: 1100px;
  margin: 20px auto;
  background:#fff;
  border-radius:10px;
  padding:20px 24px 40px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  display:none;
}

h1 { margin-top:0; }

/* ìƒë‹¨ ì»¨íŠ¸ë¡¤ë°•ìŠ¤ */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:16px;
  padding:12px;
  background:#f7f9fc;
  border-radius:8px;
}

.controls > div { min-width: 180px; }

label {
  font-size:14px;
  font-weight:600;
  display:block;
  margin-bottom:4px;
}

select,
input[type="number"],
input[type="text"],
textarea {
  width:100%;
  padding:6px 8px;
  font-size:14px;
  box-sizing:border-box;
}

button {
  padding:8px 14px;
  font-size:14px;
  cursor:pointer;
  border-radius:6px;
  border:1px solid #1f6feb;
  background:#1f6feb;
  color:#fff;
}

button.secondary {
  background:#fff;
  color:#1f2933;
  border-color:#cbd2e1;
}

button.danger {
  background:#e11d48;
  border-color:#e11d48;
  color:#fff;
}

button:disabled {
  opacity:0.6;
  cursor:not-allowed;
}

/* íƒ€ì´ë¨¸ */
#timer {
  font-size:18px;
  font-weight:bold;
  color:#e11d48;
}

#modeDesc {
  font-size:13px;
  color:#4b5563;
  margin-top:4px;
}

/* ë¬¸ì œ ë¸”ë¡ */
.question-block {
  margin-bottom:20px;
  padding-bottom:12px;
  border-bottom:1px solid #e5e7eb;
}

.question-title {
  font-weight:bold;
  margin-bottom:8px;
}

.meta {
  font-size:12px;
  color:#6b7280;
  margin-bottom:4px;
}

.option { margin:4px 0; font-size:14px; }

/* ê²°ê³¼ ë°•ìŠ¤ */
#resultBox {
  margin-top:24px;
  padding:16px;
  border-radius:8px;
  background:#ecfeff;
  border:1px solid #7dd3fc;
}

#resultBox h3 { margin-top:0; }

.explanation {
  font-size:13px;
  margin-top:4px;
  color:#334155;
}

/* íŒ¨ë„ë“¤ */
.panel-row {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:20px;
}

.panel {
  flex:1;
  min-width:260px;
  background:#f9fafb;
  border-radius:8px;
  padding:10px 12px;
  border:1px solid #e5e7eb;
  max-height:300px;
  overflow:auto;
}

.panel h3 {
  margin-top:0;
  font-size:15px;
}

.note-item,
.score-item {
  font-size:12px;
  margin-bottom:6px;
  border-bottom:1px dashed #e5e7eb;
  padding-bottom:4px;
}

/* íƒœê·¸ */
.tag {
  display:inline-block;
  font-size:11px;
  padding:1px 6px;
  border-radius:999px;
  margin-left:4px;
  background:#e5e7eb;
}

.tag.A { background:#dbeafe; }
.tag.C { background:#fef3c7; }

/* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ */
#gateOverlay {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#gateBox {
  background:#f9fafb;
  border-radius:12px;
  padding:24px 26px;
  width:320px;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

#gateBox h2 { margin-top:0; margin-bottom:12px; }

#gateMessage {
  font-size:12px;
  color:#dc2626;
  height:16px;
  margin-top:6px;
}

#gateBox input {
  width:100%;
  padding:8px;
  margin-top:8px;
  box-sizing:border-box;
}

#gateBox button { margin-top:12px; width:100%; }

/* ë¬¸ì œì¶”ê°€ */
#addQuestionForm textarea { height:60px; resize:vertical; }

#addQuestionForm .small-input {
  width:60px;
  display:inline-block;
}

</style>

</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
    <p style="font-size:11px;color:#6b7280;margin-top:12px;">
      * ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ê°„ë‹¨í•œ ì¶œì… í†µì œìš©ì…ë‹ˆë‹¤. ë³´ì•ˆìš©ìœ¼ë¡œëŠ” ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    ì±•í„° / ìœ í˜• / ë¬¸ì œ ìˆ˜ / ì‹œê°„ / ì¶œì œ ëª¨ë“œ ì„ íƒ í›„ <b>ì‹œí—˜ ì‹œì‘</b>ì„ ëˆŒëŸ¬ ì—°ìŠµí•˜ì„¸ìš”.<br/>
    ì˜¤ë‹µê³¼ ì ìˆ˜ëŠ” ë¸Œë¼ìš°ì €(LocalStorage)ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
  </p>

  <!-- ìƒë‹¨ ì˜µì…˜ -->
  <div class="controls">

    <div>
      <label>ì±•í„° ì„ íƒ</label>
      <select id="chapterSelect">
        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
      </select>
    </div>

    <div>
      <label>ë¬¸ì œ ìœ í˜•</label>
      <select id="typeSelect">
        <option value="all">A+C ì „ì²´</option>
        <option value="A">A-type (ê°œë…í˜•)</option>
        <option value="C">C-type (ê³„ì‚°/ìƒí™©í˜•)</option>
      </select>
    </div>

    <div>
      <label>ì¶œì œ ë¬¸ì œ ìˆ˜</label>
      <input id="countInput" type="number" min="1" max="200" value="10" />
    </div>

    <div>
      <label>íƒ€ì´ë¨¸ (ë¶„)</label>
      <input id="timerInput" type="number" min="0" max="240" value="60" />
    </div>

    <div>
      <label>ì¶œì œ ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜ ëª¨ë“œ</option>
        <option value="wrong">ì˜¤ë‹µë§Œ ëª¨ë“œ</option>
        <option value="weak">ì•½ì  ì±•í„° ëª¨ë“œ</option>
      </select>
    </div>

    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
      <button id="submitBtn" class="secondary" disabled>ì œì¶œ</button>
      <button id="resetBtn" class="secondary" disabled>ì´ˆê¸°í™”</button>
    </div>

    <div style="margin-left:auto; text-align:right;">
      <div id="timer">Timer: OFF</div>
      <div id="modeDesc"></div>
    </div>

  </div>

  <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
  <div id="quizBox"></div>

  <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
  <div id="resultBox"></div>

  <!-- íŒ¨ë„ ì˜ì—­ -->
  <div class="panel-row">

    <!-- ì˜¤ë‹µë…¸íŠ¸ -->
    <div class="panel">
      <h3>ğŸ“’ ì˜¤ë‹µë…¸íŠ¸ (ìë™ ì €ì¥)</h3>
      <div id="wrongNotesBox"></div>
      <button class="secondary" onclick="clearWrongNotes()">ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
    </div>

    <!-- ì ìˆ˜ ê¸°ë¡ -->
    <div class="panel">
      <h3>ğŸ“Š ì ìˆ˜ ê¸°ë¡ (LocalStorage)</h3>
      <div id="scoreHistoryBox"></div>
      <button class="secondary" onclick="clearScoreHistory()">ì ìˆ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <!-- ë¬¸ì œ ì¶”ê°€ íŒ¨ë„ -->
    <div class="panel">
      <h3>â• ë¬¸ì œ ì¶”ê°€ (ë¸Œë¼ìš°ì €ì— ì €ì¥)</h3>
      <form id="addQuestionForm">
        <label>ë¬¸ì œ ID</label>
        <input type="text" id="addId" placeholder="ì˜ˆ: Q100-1" required />

        <label>ì±•í„°</label>
        <select id="addChapter"></select>

        <label>ìœ í˜•</label>
        <select id="addType">
          <option value="A">A-type</option>
          <option value="C">C-type</option>
        </select>

        <label>ë¬¸ì œ ë‚´ìš©</label>
        <textarea id="addText" required></textarea>

        <label>ë³´ê¸° A/B/C/D</label>
        <input type="text" id="addOpA" placeholder="ë³´ê¸° A" required />
        <input type="text" id="addOpB" placeholder="ë³´ê¸° B" required />
        <input type="text" id="addOpC" placeholder="ë³´ê¸° C" required />
        <input type="text" id="addOpD" placeholder="ë³´ê¸° D" required />

        <label>ì •ë‹µ (0=A, 1=B, 2=C, 3=D)</label>
        <input type="number" id="addAnswer" min="0" max="3" class="small-input" value="0" required />

        <label>í•´ì„¤</label>
        <textarea id="addExplanation" required></textarea>

        <button type="submit" class="secondary" style="margin-top:8px;">ë¬¸ì œ ì¶”ê°€</button>
      </form>

      <hr style="margin:10px 0;">
      <h4>ğŸ“ JSON ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ</h4>
      <input type="file" id="uploadFileInput" accept=".json" />
      <button class="secondary" id="uploadFileBtn" style="margin-top:6px;">íŒŒì¼ì—ì„œ ë¬¸ì œ ì¶”ê°€</button>

      <p style="font-size:11px;color:#6b7280;">
        JSON ë°°ì—´ í˜•ì‹: { id, chapter, type, text, options[4], answer, explanation }
      </p>

      <hr style="margin:10px 0;">
      <h4>ğŸ“¦ ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬</h4>
      <button class="danger" id="clearCustomBtn">ì‚¬ìš©ì ì¶”ê°€ ë¬¸ì œ ì‚­ì œ</button>
      <button class="secondary" id="exportCustomBtn" style="margin-top:4px;">ì‚¬ìš©ì ë¬¸ì œ JSON ë‹¤ìš´ë¡œë“œ</button>
    </div>

  </div>

</div>

<!-- JS ì˜ì—­ â€” ë©”ì‹œì§€ â‘¢ì—ì„œ ì´ê³³ì— ë¶™ì—¬ë„£ìŒ -->
<script>
/* === JAVASCRIPT WILL BE INSERTED HERE (MESSAGE â‘¢) === */

  /***********************************************************
 * 0. ì„¤ì •: ë¹„ë°€ë²ˆí˜¸
 ***********************************************************/
const APP_PASSWORD = "cre2025";  // í•„ìš”í•˜ë©´ ë³€ê²½ ê°€ëŠ¥

/***********************************************************
 * 1. ê¸°ë³¸ ë¬¸ì œ ë°ì´í„° (ì±•í„°ëª… ë°˜ì˜)
 ***********************************************************/
const BASE_QUESTIONS = [
  // ì±•í„° 4 - Statistical Concepts
  {
    id: "Q1",
    chapter: "ì±•í„° 4 - Statistical Concepts",
    type: "C",
    text: "Exponential ë¶„í¬ì—ì„œ MTBF = 800ì‹œê°„ì¼ ë•Œ, 400ì‹œê°„ì˜ ì‹ ë¢°ë„ R(400)ì— ê°€ì¥ ê°€ê¹Œìš´ ê°’ì€?",
    options: ["0.50","0.61","0.37","0.80"],
    answer: 1,
    explanation: "R = exp(-t/MTBF) = exp(-0.5) â‰ˆ 0.6065 â†’ 0.61",
  },
  {
    id: "Q2",
    chapter: "ì±•í„° 4 - Statistical Concepts",
    type: "C",
    text: "Exponential ìˆ˜ëª…ì‹œí—˜ì—ì„œ ì´ ì‹œí—˜ì‹œê°„ T = 4000h, ê³ ì¥ìˆ˜ r = 3ì¼ ë•Œ 90% MTBF í•˜í•œì€?",
    options: [
      "2T / Ï‡Â²(2r; lower 0.10)",
      "2T / Ï‡Â²(2r; upper 0.10)",
      "T / r",
      "T / (r-1)"
    ],
    answer: 1,
    explanation: "Lower one-sided LCB = 2T / Ï‡Â²(2r; upper Î±).",
  },
  {
    id: "Q3",
    chapter: "ì±•í„° 4 - Statistical Concepts",
    type: "C",
    text: "ì •ê·œë¶„í¬(Î¼=50, Ïƒ=10)ì—ì„œ 40 ì´í•˜ì¼ í™•ë¥ ì€?",
    options: ["ì•½ 0.16","ì•½ 0.30","ì•½ 0.50","ì•½ 0.84"],
    answer: 0,
    explanation: "Z=-1 â†’ Î¦(-1)=0.1587",
  },
  {
    id: "Q4",
    chapter: "ì±•í„° 4 - Statistical Concepts",
    type: "A",
    text: "Exponential ë¶„í¬ì—ì„œ R(MTBF) ê°’ì€?",
    options: ["0.50","0.37","0.63","0.90"],
    answer: 1,
    explanation: "R=exp(-1)=0.3679",
  },
  {
    id: "Q5",
    chapter: "ì±•í„° 4 - Statistical Concepts",
    type: "A",
    text: "Weibull ë¶„í¬ì—ì„œ Î² > 1 ì˜ë¯¸ëŠ”?",
    options: [
      "ì´ˆê¸°ê³ ì¥(Infant Mortality)",
      "ë§ˆëª¨ê³ ì¥(Wear-out), ê³ ì¥ë¥  ì¦ê°€",
      "ê³ ì¥ë¥  ì¼ì •",
      "ë¬´ì‘ìœ„(Random)"
    ],
    answer: 1,
    explanation: "Î²>1 â†’ ê³ ì¥ë¥  ì¦ê°€",
  },

  // ì±•í„° 7 - Testing and Modeling
  {
    id: "Q6",
    chapter: "ì±•í„° 7 - Testing and Modeling",
    type: "A",
    text: "ALTì˜ í•µì‹¬ ëª©ì ì€?",
    options: [
      "ì„¤ê³„í•œê³„ ì°¾ê¸°",
      "ë‹¨ê¸°ê°„ ë°ì´í„° ìˆ˜ì§‘ í›„ ì •ìƒì¡°ê±´ ìˆ˜ëª… ì˜ˆì¸¡",
      "Cpk í–¥ìƒ",
      "íŒŒê´´ì‹œí—˜ í›„ ê³ ì¥ ì œê±°"
    ],
    answer: 1,
    explanation: "Accelerated Life Testingì€ ì§§ì€ ì‹œê°„ ë‚´ ìˆ˜ëª… ì˜ˆì¸¡ ëª©ì ",
  },
  {
    id: "Q7",
    chapter: "ì±•í„° 7 - Testing and Modeling",
    type: "A",
    text: "Peck ëª¨ë¸ì€ ë¬´ì—‡ì„ ê³ ë ¤í•˜ëŠ”ê°€?",
    options: [
      "ì˜¨ë„ë§Œ",
      "ìŠµë„ë§Œ",
      "ì˜¨ë„ + ìŠµë„",
      "ì „ì•• + ì§„ë™"
    ],
    answer: 2,
    explanation: "Peck = ì˜¨ë„ + ìŠµë„",
  },
  {
    id: "Q8",
    chapter: "ì±•í„° 7 - Testing and Modeling",
    type: "A",
    text: "Step-stress ì‹œí—˜ ì •ì˜ëŠ”?",
    options: [
      "ìŠ¤íŠ¸ë ˆìŠ¤ ì¼ì •",
      "ì‹œê°„ì— ë”°ë¼ ë‹¨ê³„ì ìœ¼ë¡œ ì¦ê°€",
      "ì‹œê°„ì— ë”°ë¼ ë‹¨ê³„ì ìœ¼ë¡œ ê°ì†Œ",
      "ë¬´ì‘ìœ„ ìŠ¤íŠ¸ë ˆìŠ¤"
    ],
    answer: 1,
    explanation: "Step-stress = ë‹¨ê³„ì ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆìŠ¤ ìƒìŠ¹",
  },
  {
    id: "Q9",
    chapter: "ì±•í„° 7 - Testing and Modeling",
    type: "C",
    text: "0.7, 0.8, 0.9 ë³‘ë ¬ ì‹œìŠ¤í…œ Rì€?",
    options: ["0.90","0.97","0.50","0.80"],
    answer: 1,
    explanation: "R = 1-(0.3)(0.2)(0.1)=0.994 â†’ ë³´ê¸° ì¤‘ 0.97ì´ ê°€ì¥ ê·¼ì ‘",
  },
  {
    id: "Q10",
    chapter: "ì±•í„° 7 - Testing and Modeling",
    type: "C",
    text: "Perfect Standby: Active=0.9, Standby=0.8 ì‹œìŠ¤í…œ Rì€?",
    options: ["0.90","0.92","0.98","0.99"],
    answer: 2,
    explanation: "Rsys=0.9+0.1Ã—0.8=0.98",
  },

  // ì±•í„° 3 - Risk Management
  {
    id: "Q11",
    chapter: "ì±•í„° 3 - Risk Management",
    type: "A",
    text: "Common Cause Failure ì •ì˜?",
    options: [
      "ë…ë¦½ ê³ ì¥ì´ ë™ì‹œì— ë°œìƒ",
      "ë™ì¼ ì›ì¸ìœ¼ë¡œ ë³‘ë ¬ ê²½ë¡œ ë™ì‹œì— ê³ ì¥",
      "í™˜ê²½ ë¬´ê´€ ëœë¤ê³ ì¥",
      "ìˆ˜ë¦¬ ê³¼ì • ê³ ì¥"
    ],
    answer: 1,
    explanation: "CCF = í•˜ë‚˜ì˜ ì›ì¸ì´ ì—¬ëŸ¬ ê²½ë¡œ ê³ ì¥ ìœ ë°œ",
  },
  {
    id: "Q12",
    chapter: "ì±•í„° 3 - Risk Management",
    type: "A",
    text: "FTA ì¥ì ì€?",
    options: [
      "ì „ì²´ ê³ ì¥ ëª¨ë“œ ë¶„ì„",
      "ì‹œê°„ë³„ ê³ ì¥ë¥  ì¶”ì„¸ë¶„ì„",
      "Top Event ì¤‘ì‹¬ ì›ì¸ ë¶„ì„",
      "ìš”ì¸ ìƒí˜¸ì‘ìš© ë¶„ì„"
    ],
    answer: 2,
    explanation: "FTA = Top Event ì¤‘ì‹¬ ë¶„ì„ ê¸°ë²•",
  },

  // ì±•í„° 8 - Reliability Designs
  {
    id: "Q13",
    chapter: "ì±•í„° 8 - Reliability Designs",
    type: "A",
    text: "DOEì—ì„œ ë¸”ë¡(block)ì˜ ì •ì˜?",
    options: [
      "ìš”ì¸ ìˆ˜ì¤€",
      "ê· ì¼í•œ ì§‘ë‹¨(ì™¸ë¶€ë³€ë™ í†µì œ ëª©ì )",
      "ë°˜ë³µ(run)",
      "ìƒí˜¸ì‘ìš© íš¨ê³¼"
    ],
    answer: 1,
    explanation: "ë¸”ë¡ = ê· ì¼í•œ ê·¸ë£¹",
  },
  {
    id: "Q14",
    chapter: "ì±•í„° 8 - Reliability Designs",
    type: "A",
    text: "Taguchi Loss Function í˜•íƒœ?",
    options: [
      "ê·œê²© ë‚´ ì†ì‹¤ 0",
      "ì†ì‹¤ì€ (y-T)^2 ì— ë¹„ë¡€",
      "ì„ í˜• ì¦ê°€",
      "ìƒìˆ˜"
    ],
    answer: 1,
    explanation: "L=k(y-T)^2",
  },
  {
    id: "Q15",
    chapter: "ì±•í„° 8 - Reliability Designs",
    type: "A",
    text: "Robust Design í•µì‹¬?",
    options: [
      "ë¹„ìš© ìµœì†Œí™”",
      "Cpk ìµœëŒ€í™”",
      "Noise ìš”ì¸ ë¯¼ê°ë„ ê°ì†Œ",
      "ì‹œí—˜ ì‹œê°„ ë‹¨ì¶•"
    ],
    answer: 2,
    explanation: "ê°•ê±´ì„¤ê³„ = Noise Sensitivity â†“",
  },

  // ì±•í„° 9 - Maintainability
  {
    id: "Q16",
    chapter: "ì±•í„° 9 - Maintainability",
    type: "A",
    text: "RCM ëª©ì ?",
    options: [
      "ì „ì²´ ìœ ì§€ë¹„ ìµœì†Œí™”",
      "ì‹œìŠ¤í…œ ê°€ìš©ì„± ì¶”ì •",
      "ì¤‘ìš” ê³ ì¥ ëª¨ë“œ ì¤‘ì‹¬ ì˜ˆë°©ë³´ì „ ì •ì˜",
      "ì „ì²´ ë¶€í’ˆ ë™ì¼ì£¼ê¸° êµì²´"
    ],
    answer: 2,
    explanation: "RCM = ì¤‘ìš” ê³ ì¥ëª¨ë“œ ì˜ˆë°© ì¤‘ì ",
  },
  {
    id: "Q17",
    chapter: "ì±•í„° 9 - Maintainability",
    type: "C",
    text: "MTBM=1700h, MDT=34h â†’ Ao?",
    options: ["0.90","0.95","0.98","0.99"],
    answer: 2,
    explanation: "Ao = 1700 / (1700+34) â‰ˆ 0.981",
  },
];

/***********************************************************
 * 2. LocalStorage Helper
 ***********************************************************/
function loadWrongNotes() {
  try { return JSON.parse(localStorage.getItem("creWrongNotes") || "[]"); }
  catch { return []; }
}
function saveWrongNotes(v){ localStorage.setItem("creWrongNotes", JSON.stringify(v)); }

function loadScoreHistory(){
  try { return JSON.parse(localStorage.getItem("creScoreHistory") || "[]"); }
  catch { return []; }
}
function saveScoreHistory(v){ localStorage.setItem("creScoreHistory", JSON.stringify(v)); }

function loadCustomQuestions(){
  try { return JSON.parse(localStorage.getItem("creCustomQuestions") || "[]"); }
  catch { return []; }
}
function saveCustomQuestions(v){
  localStorage.setItem("creCustomQuestions", JSON.stringify(v));
}

/***********************************************************
 * 3. ë™ì  ì±•í„° ëª©ë¡ ìƒì„± ê¸°ëŠ¥
 ***********************************************************/
function refreshChapterDropdown() {
  const chapterSelect = document.getElementById("chapterSelect");
  const addChapterSelect = document.getElementById("addChapter");

  const base = BASE_QUESTIONS;
  const custom = loadCustomQuestions();
  const all = base.concat(custom);

  const chapterSet = new Set(["ì „ì²´"]);
  all.forEach(q => chapterSet.add(q.chapter));

  chapterSelect.innerHTML = "";
  addChapterSelect.innerHTML = "";

  chapterSet.forEach(ch => {
    chapterSelect.innerHTML += `<option value="${ch === 'ì „ì²´' ? 'all' : ch}">${ch}</option>`;
    if (ch !== "ì „ì²´") {
      addChapterSelect.innerHTML += `<option value="${ch}">${ch}</option>`;
    }
  });
}

/***********************************************************
 * 4. BASE + Custom ë¬¸ì œ í•©ì¹˜ê¸°
 ***********************************************************/
function getAllQuestions() {
  return BASE_QUESTIONS.concat(loadCustomQuestions());
}

/***********************************************************
 * 5. ì˜¤ë‹µë…¸íŠ¸ / ì ìˆ˜ í‘œì‹œ
 ***********************************************************/
function renderWrongNotes() {
  const box = document.getElementById("wrongNotesBox");
  const notes = loadWrongNotes();

  if (!notes.length) {
    box.innerHTML = "<div style='font-size:12px;color:#6b7280;'>ì˜¤ë‹µ ì—†ìŒ</div>";
    return;
  }

  box.innerHTML = notes.map(n => `
    <div class="note-item">
      <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
      <div>${n.text}</div>
      <div style="font-size:11px;color:#6b7280;">
        ì±•í„°: ${n.chapter} Â· íšŸìˆ˜: ${n.missCount} Â· ë§ˆì§€ë§‰: ${n.lastDate}
      </div>
    </div>
  `).join("");
}

function renderScoreHistory() {
  const box = document.getElementById("scoreHistoryBox");
  const hist = loadScoreHistory();
  if (!hist.length) {
    box.innerHTML = "<div style='font-size:12px;color:#6b7280;'>ê¸°ë¡ ì—†ìŒ</div>";
    return;
  }

  box.innerHTML = hist.slice().reverse().map(h => `
    <div class="score-item">
      <b>${h.date}</b> â€” ${h.correct}/${h.total} (${Math.round(h.correct/h.total*100)}%)
      <div style="font-size:11px;color:#6b7280;">${h.mode} Â· ${h.durationSec}s</div>
    </div>
  `).join("");
}

function clearWrongNotes(){
  if(confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")){
    saveWrongNotes([]);
    renderWrongNotes();
  }
}
function clearScoreHistory(){
  if(confirm("ì ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")){
    saveScoreHistory([]);
    renderScoreHistory();
  }
}

/***********************************************************
 * 6. íƒ€ì´ë¨¸
 ***********************************************************/
let timerId = null;
let timerSeconds = 0;
let quizStarted = false;
let quizStartTime = null;
let currentQuiz = [];

function updateTimerDisplay(){
  const el = document.getElementById("timer");
  if (timerSeconds <= 0){
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSeconds/60)).padStart(2,"0");
  const s = String(timerSeconds%60).padStart(2,"0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startTimer(sec){
  clearInterval(timerId);
  timerSeconds = sec;
  updateTimerDisplay();
  if(sec <= 0) return;

  timerId = setInterval(()=>{
    timerSeconds--;
    updateTimerDisplay();
    if(timerSeconds <= 0){
      clearInterval(timerId);
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œë©ë‹ˆë‹¤.");
      submitQuiz(true);
    }
  },1000);
}

function stopTimer(){ clearInterval(timerId); }

/***********************************************************
 * 7. ë¬¸ì œ ì„ê¸°
 ***********************************************************/
function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/***********************************************************
 * 8. í€´ì¦ˆ í™”ë©´ ë Œë”ë§
 ***********************************************************/
function renderQuiz(){
  const box = document.getElementById("quizBox");
  box.innerHTML = "";

  currentQuiz.forEach((q, idx)=>{
    let html = `
      <div class="question-block">
        <div class="question-title">Q${idx+1}. ${q.text}</div>
        <div class="meta">ID: ${q.id} Â· ${q.chapter} Â· ${q.type}</div>
    `;
    q.options.forEach((op, j)=>{
      html += `
        <div class="option">
          <label>
            <input type="radio" name="q${idx}" value="${j}" />
            ${String.fromCharCode(65+j)}. ${op}
          </label>
        </div>`;
    });
    html += "</div>";
    box.innerHTML += html;
  });
}

/***********************************************************
 * 9. ì¶œì œ í’€ ìƒì„± (normal / wrong / weak)
 ***********************************************************/
function buildQuestionPool(){
  const chapter = document.getElementById("chapterSelect").value;
  const qType   = document.getElementById("typeSelect").value;
  const mode    = document.getElementById("modeSelect").value;

  const all = getAllQuestions();
  const notes = loadWrongNotes();

  let pool = [];

  if (mode === "normal"){
    pool = all.filter(q =>
      (chapter==="all" || q.chapter===chapter) &&
      (qType==="all" || q.type===qType)
    );
  }

  else if (mode === "wrong"){
    const wrongIds = notes.map(n=>n.id);
    pool = all.filter(q =>
      wrongIds.includes(q.id) &&
      (chapter==="all" || q.chapter===chapter) &&
      (qType==="all" || q.type===qType)
    );
  }

  else if (mode === "weak"){
    if (!notes.length){
      alert("ì˜¤ë‹µë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì•½ì  ì±•í„° ê³„ì‚° ë¶ˆê°€.");
      return { pool: [], autoChapter:null };
    }

    const counts = {};
    notes.forEach(n=>{
      counts[n.chapter] = (counts[n.chapter]||0) + n.missCount;
    });

    let weakChapter=null, max=-1;
    Object.keys(counts).forEach(ch=>{
      if(counts[ch] > max){
        max = counts[ch];
        weakChapter = ch;
      }
    });

    pool = all.filter(q =>
      q.chapter === weakChapter &&
      (qType==="all" || q.type===qType)
    );

    return { pool, autoChapter:weakChapter };
  }

  return { pool, autoChapter:null };
}

/***********************************************************
 * 10. í€´ì¦ˆ ì‹œì‘
 ***********************************************************/
function startQuiz(){
  const count = Number(document.getElementById("countInput").value);
  const timerMin = Number(document.getElementById("timerInput").value);
  const mode = document.getElementById("modeSelect").value;

  const { pool, autoChapter } = buildQuestionPool();
  if(!pool.length){
    alert("ì¶œì œ ê°€ëŠ¥í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  currentQuiz = shuffleArray(pool).slice(0, count || pool.length);
  renderQuiz();

  quizStarted = true;
  quizStartTime = Date.now();

  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("resetBtn").disabled = false;

  let desc = [];
  desc.push(mode==="normal" ? "ì¼ë°˜" :
            mode==="wrong"  ? "ì˜¤ë‹µë§Œ" :
            "ì•½ì  ì±•í„°");

  if (mode==="weak" && autoChapter){
    desc.push(`ì±•í„°=${autoChapter}`);
  } else {
    const chapter = document.getElementById("chapterSelect").value;
    desc.push(chapter==="all" ? "ì „ì²´ ì±•í„°" : `ì±•í„°=${chapter}`);
  }

  const qType = document.getElementById("typeSelect").value;
  desc.push(qType==="all" ? "A+C" : `ìœ í˜•=${qType}`);
  desc.push(`ë¬¸ì œ=${currentQuiz.length}`);

  document.getElementById("modeDesc").textContent = desc.join(" / ");

  startTimer(timerMin>0 ? timerMin*60 : 0);
}

/***********************************************************
 * 11. ì œì¶œ / ì±„ì 
 ***********************************************************/
function submitQuiz(auto=false){
  if(!quizStarted) return;
  quizStarted = false;
  stopTimer();

  const durationSec = Math.round((Date.now()-quizStartTime)/1000);
  let correct = 0;
  let html = "";
  let wrongToAdd = [];

  currentQuiz.forEach((q, idx)=>{
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const userIdx = sel ? Number(sel.value) : null;
    const ok = (userIdx === q.answer);
    if(ok) correct++;

    const user = sel ? `${String.fromCharCode(65+userIdx)}. ${q.options[userIdx]}`:"ë¬´ì‘ë‹µ";
    const corr = `${String.fromCharCode(65+q.answer)}. ${q.options[q.answer]}`;

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx+1} (${q.id})</b><br/>
        ë‹µ: ${user}<br/>
        ì •ë‹µ: <span style="color:${ok?'#16a34a':'#dc2626'}">${corr}</span>
        <div class="explanation">${q.explanation}</div>
      </div>`;

    if(!ok) wrongToAdd.push(q);
  });

  const pct = Math.round(correct/currentQuiz.length*100);

  document.getElementById("resultBox").innerHTML = `
    <h3>ì ìˆ˜: ${correct} / ${currentQuiz.length} (${pct}%)</h3>
    <div style="font-size:12px;color:#6b7280;">
      ì†Œìš”ì‹œê°„: ${durationSec}s ${auto ? "(ìë™ ì œì¶œ)" : ""}
    </div>
    ${html}
  `;

  document.getElementById("submitBtn").disabled = true;

  // ì˜¤ë‹µ ì €ì¥
  if(wrongToAdd.length){
    const notes = loadWrongNotes();
    const now = new Date().toLocaleString();

    wrongToAdd.forEach(q=>{
      const ex = notes.find(n=>n.id===q.id);
      if(ex){
        ex.missCount++;
        ex.lastDate = now;
      } else {
        notes.push({
          id: q.id,
          text: q.text,
          chapter: q.chapter,
          type: q.type,
          missCount: 1,
          lastDate: now
        });
      }
    });

    saveWrongNotes(notes);
    renderWrongNotes();
  }

  // ì ìˆ˜ ì €ì¥
  const hist = loadScoreHistory();
  hist.push({
    date:new Date().toLocaleString(),
    mode:document.getElementById("modeDesc").textContent,
    total:currentQuiz.length,
    correct,
    durationSec
  });
  saveScoreHistory(hist);
  renderScoreHistory();
}

/***********************************************************
 * 12. ì‹œí—˜ í™”ë©´ ì´ˆê¸°í™”
 ***********************************************************/
function resetQuiz(){
  stopTimer();
  quizStarted = false;
  currentQuiz = [];
  document.getElementById("quizBox").innerHTML = "";
  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("modeDesc").textContent = "";
  document.getElementById("timer").textContent = "Timer: OFF";

  document.getElementById("startBtn").disabled = false;
  document.getElementById("submitBtn").disabled = true;
  document.getElementById("resetBtn").disabled = true;
}

/***********************************************************
 * 13. ë¬¸ì œ ì¶”ê°€ í¼ (1ê°œì”©)
 ***********************************************************/
function setupAddQuestionForm(){
  const form = document.getElementById("addQuestionForm");
  form.addEventListener("submit", e=>{
    e.preventDefault();

    const q = {
      id: document.getElementById("addId").value.trim(),
      chapter: document.getElementById("addChapter").value,
      type: document.getElementById("addType").value,
      text: document.getElementById("addText").value.trim(),
      options: [
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim(),
      ],
      answer: Number(document.getElementById("addAnswer").value),
      explanation: document.getElementById("addExplanation").value.trim()
    };

    if(!q.id || !q.text || q.options.some(v=>!v) || q.answer<0 || q.answer>3 || !q.explanation){
      alert("ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const custom = loadCustomQuestions();
    const exists = custom.some(c=>c.id===q.id) || BASE_QUESTIONS.some(b=>b.id===q.id);
    if(exists){
      alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.");
      return;
    }

    custom.push(q);
    saveCustomQuestions(custom);

    alert("ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    refreshChapterDropdown();
    form.reset();
    document.getElementById("addAnswer").value = 0;
  });
}

/***********************************************************
 * 14. JSON ë¬¸ì œ ì—…ë¡œë“œ
 ***********************************************************/
function setupUploadQuestions(){
  const input = document.getElementById("uploadFileInput");
  const btn = document.getElementById("uploadFileBtn");

  btn.addEventListener("click", ()=>{
    const file = input.files?.[0];
    if(!file){
      alert("JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const arr = JSON.parse(e.target.result);
        if(!Array.isArray(arr)){
          alert("JSON ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        const custom = loadCustomQuestions();
        const allIds = new Set([
          ...BASE_QUESTIONS.map(q=>q.id),
          ...custom.map(q=>q.id)
        ]);

        const valid = arr.filter(q=>{
          return q.id && q.chapter && q.text &&
                 Array.isArray(q.options) && q.options.length===4 &&
                 typeof q.answer==="number";
        });

        const newOnes = valid.filter(q=>!allIds.has(q.id));

        saveCustomQuestions(custom.concat(newOnes));
        alert(`${newOnes.length}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

        refreshChapterDropdown();
        input.value = "";
      }
      catch(err){
        alert("JSON íŒŒì‹± ì˜¤ë¥˜");
      }
    };
    reader.readAsText(file);
  });
}

/***********************************************************
 * 15. ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬ (ì´ˆê¸°í™” + Export)
 ***********************************************************/
function setupCustomManagement(){
  const clearBtn = document.getElementById("clearCustomBtn");
  const exportBtn = document.getElementById("exportCustomBtn");

  clearBtn.addEventListener("click", ()=>{
    if(confirm("ì‚¬ìš©ì ì¶”ê°€ ë¬¸ì œë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")){
      saveCustomQuestions([]);
      refreshChapterDropdown();
      alert("ì‚­ì œ ì™„ë£Œ");
    }
  });

  exportBtn.addEventListener("click", ()=>{
    const data = loadCustomQuestions();
    if(!data.length){
      alert("ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `cre_custom_questions_${new Date().toISOString().slice(0,10)}.json`;
    a.click();

    URL.revokeObjectURL(url);
  });
}

/***********************************************************
 * 16. ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
 ***********************************************************/
function setupGate(){
  const overlay = document.getElementById("gateOverlay");
  const input = document.getElementById("gatePassword");
  const btn = document.getElementById("gateBtn");
  const msg = document.getElementById("gateMessage");
  const app = document.getElementById("appContainer");

  function enter(){
    if(input.value === APP_PASSWORD){
      overlay.style.display = "none";
      app.style.display = "block";
      renderWrongNotes();
      renderScoreHistory();
      refreshChapterDropdown();
    } else {
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter") enter();
  });
}

/***********************************************************
 * ì´ˆê¸° ì‹¤í–‰
 ***********************************************************/
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("submitBtn").addEventListener("click", ()=>submitQuiz(false));
document.getElementById("resetBtn").addEventListener("click", resetQuiz);

setupAddQuestionForm();
setupUploadQuestions();
setupCustomManagement();
setupGate();

</script>

</body>
</html>
