<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT</title>

<style>
  body {
    font-family: Arial, system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background:#f2f4f7;
  }

  /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
  .container {
    max-width: 1100px;
    margin: 20px auto;
    background:#fff;
    border-radius:10px;
    padding:20px 24px 40px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:none;
  }

  h1 { margin-top:0; }

  /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ */
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:16px;
    padding:12px;
    background:#f7f9fc;
    border-radius:8px;
  }

  .controls > div { min-width: 180px; }

  label {
    font-size:14px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }

  select,
  input[type="number"],
  input[type="text"],
  textarea {
    width:100%;
    padding:6px 8px;
    font-size:14px;
    box-sizing:border-box;
  }

  button {
    padding:8px 14px;
    font-size:14px;
    cursor:pointer;
    border-radius:6px;
    border:1px solid #1f6feb;
    background:#1f6feb;
    color:#fff;
  }

  button.secondary {
    background:#fff;
    color:#1f2933;
    border-color:#cbd2e1;
  }

  button.danger {
    background:#e11d48;
    border-color:#e11d48;
    color:#fff;
  }

  button:disabled {
    opacity:0.6;
    cursor:not-allowed;
  }

  /* íƒ€ì´ë¨¸ */
  #timer {
    font-size:18px;
    font-weight:bold;
    color:#e11d48;
  }

  #modeDesc {
    font-size:13px;
    color:#4b5563;
    margin-top:4px;
  }

  /* ë¬¸ì œ ë¸”ë¡ ê¸°ë³¸ */
  .question-block {
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid #e5e7eb;
  }

  .question-title {
    font-weight:bold;
    margin-bottom:8px;
  }

  .meta {
    font-size:12px;
    color:#6b7280;
    margin-bottom:4px;
  }

  .option { margin:4px 0; font-size:14px; }

  /* â— 2ë‹¨(ì˜/í•œ) ë¬¸ì œ ë¸”ë¡ */
  .question-block.dual {
    display:flex;
    gap:16px;
  }

  .q-left, .q-right {
    width:50%;
    box-sizing:border-box;
  }

  .q-right {
    border-left:1px solid #e5e7eb;
    padding-left:14px;
    font-size:13px;
    color:#374151;
  }

  .ko-header {
    font-weight:bold;
    margin-bottom:4px;
    font-size:13px;
    color:#111827;
  }

  .ko-label {
    font-size:12px;
    font-weight:bold;
    color:#4b5563;
    margin-top:4px;
  }

  .ko-option {
    font-size:13px;
    margin:3px 0;
  }

  @media (max-width: 900px){
    .question-block.dual{
      flex-direction:column;
    }
    .q-left,.q-right{
      width:100%;
    }
    .q-right{
      border-left:none;
      border-top:1px solid #e5e7eb;
      padding-left:0;
      padding-top:8px;
    }
  }

  /* ê²°ê³¼ ë°•ìŠ¤ */
  #resultBox {
    margin-top:24px;
    padding:16px;
    border-radius:8px;
    background:#ecfeff;
    border:1px solid #7dd3fc;
  }

  #resultBox h3 { margin-top:0; }

  .explanation {
    font-size:13px;
    margin-top:4px;
    color:#334155;
  }

  .ko-result-block {
    font-size:12px;
    margin-top:4px;
    padding:6px 8px;
    background:#f9fafb;
    border-radius:4px;
    border:1px dashed #e5e7eb;
  }

  .ko-result-block b {
    color:#4b5563;
  }

  /* íŒ¨ë„ë“¤ */
  .panel-row {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:20px;
  }

  .panel {
    flex:1;
    min-width:260px;
    background:#f9fafb;
    border-radius:8px;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    max-height:300px;
    overflow:auto;
  }

  .panel h3 {
    margin-top:0;
    font-size:15px;
  }

  .note-item,
  .score-item {
    font-size:12px;
    margin-bottom:6px;
    border-bottom:1px dashed #e5e7eb;
    padding-bottom:4px;
  }

  /* íƒœê·¸ */
  .tag {
    display:inline-block;
    font-size:11px;
    padding:1px 6px;
    border-radius:999px;
    margin-left:4px;
    background:#e5e7eb;
  }

  .tag.A { background:#dbeafe; }
  .tag.C { background:#fef3c7; }

  /* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ */
  #gateOverlay {
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }

  #gateBox {
    background:#f9fafb;
    border-radius:12px;
    padding:24px 26px;
    width:320px;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }

  #gateBox h2 { margin-top:0; margin-bottom:12px; }

  #gateMessage {
    font-size:12px;
    color:#dc2626;
    height:16px;
    margin-top:6px;
  }

  #gateBox input {
    width:100%;
    padding:8px;
    margin-top:8px;
    box-sizing:border-box;
  }

  #gateBox button { margin-top:12px; width:100%; }

  /* ë¬¸ì œì¶”ê°€ */
  #addQuestionForm textarea { height:60px; resize:vertical; }

  #addQuestionForm .small-input {
    width:60px;
    display:inline-block;
  }

  /* 2ë‹¨ í† ê¸€ ë¼ë²¨ */
  .dual-toggle-inner {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:13px;
    font-weight:500;
  }
</style>
</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
    <p style="font-size:11px;color:#6b7280;margin-top:12px;">
      * ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ê°„ë‹¨í•œ ì¶œì… í†µì œìš©ì…ë‹ˆë‹¤. ë³´ì•ˆìš©ìœ¼ë¡œëŠ” ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </p>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    ì±•í„° / ìœ í˜• / ë¬¸ì œ ìˆ˜ / ì‹œê°„ / ì¶œì œ ëª¨ë“œ ì„ íƒ í›„ <b>ì‹œí—˜ ì‹œì‘</b>ì„ ëˆŒëŸ¬ ì—°ìŠµí•˜ì„¸ìš”.<br/>
    ì˜¤ë‹µê³¼ ì ìˆ˜ëŠ” ë¸Œë¼ìš°ì €(LocalStorage)ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.
  </p>

  <!-- ìƒë‹¨ ì˜µì…˜ -->
  <div class="controls">
    <div>
      <label>ì±•í„° ì„ íƒ</label>
      <select id="chapterSelect">
        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
      </select>
    </div>

    <div>
      <label>ìœ í˜• ì„ íƒ</label>
      <select id="typeSelect">
        <option value="all">A+C ì „ì²´</option>
        <option value="A">A-type (ê°œë…í˜•)</option>
        <option value="C">C-type (ê³„ì‚°/ìƒí™©í˜•)</option>
      </select>
    </div>

    <div>
      <label>ë¬¸ì œ ìˆ˜</label>
      <input id="countInput" type="number" min="1" max="200" value="10" />
    </div>

    <div>
      <label>íƒ€ì´ë¨¸(ë¶„)</label>
      <input id="timerInput" type="number" min="0" max="240" value="60" />
    </div>

    <div>
      <label>ì¶œì œ ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜</option>
        <option value="wrong">ì˜¤ë‹µë§Œ</option>
        <option value="weak">ì•½ì  ì±•í„°</option>
      </select>
    </div>

    <!-- ì˜/í•œ 2ë‹¨ ë³´ê¸° í† ê¸€ -->
    <div>
      <label>ë³´ê¸° ëª¨ë“œ</label>
      <div class="dual-toggle-inner">
        <input type="checkbox" id="dualViewToggle" />
        <span>ì˜/í•œ 2ë‹¨ ë³´ê¸°</span>
      </div>
    </div>

    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
      <button id="submitBtn" class="secondary" disabled>ì œì¶œ</button>
      <button id="resetBtn" class="secondary" disabled>ì´ˆê¸°í™”</button>
    </div>

    <div style="margin-left:auto; text-align:right;">
      <div id="timer">Timer: OFF</div>
      <div id="modeDesc"></div>
    </div>
  </div>

  <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
  <div id="quizBox"></div>

  <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
  <div id="resultBox"></div>

  <!-- íŒ¨ë„ ì˜ì—­ -->
  <div class="panel-row">
    <!-- ì˜¤ë‹µë…¸íŠ¸ -->
    <div class="panel">
      <h3>ğŸ“’ ì˜¤ë‹µë…¸íŠ¸ (ìë™ ì €ì¥)</h3>
      <div id="wrongNotesBox"></div>
      <button class="secondary" onclick="clearWrongNotes()">ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
    </div>

    <!-- ì ìˆ˜ ê¸°ë¡ -->
    <div class="panel">
      <h3>ğŸ“Š ì ìˆ˜ ê¸°ë¡ (LocalStorage)</h3>
      <div id="scoreHistoryBox"></div>
      <button class="secondary" onclick="clearScoreHistory()">ì ìˆ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <!-- ë¬¸ì œ ì¶”ê°€ íŒ¨ë„ -->
    <div class="panel">
      <h3>â• ë¬¸ì œ ì¶”ê°€ (ë¸Œë¼ìš°ì €ì— ì €ì¥)</h3>
      <form id="addQuestionForm">
        <label>ë¬¸ì œ ID</label>
        <input type="text" id="addId" placeholder="ì˜ˆ: Q100-1" required />

        <label>ì±•í„°</label>
        <select id="addChapter"></select>

        <label>ìœ í˜•</label>
        <select id="addType">
          <option value="A">A-type</option>
          <option value="C">C-type</option>
        </select>

        <label>ë¬¸ì œ ë‚´ìš© (ì˜ë¬¸)</label>
        <textarea id="addText" required></textarea>

        <label>ë³´ê¸° A/B/C/D (ì˜ë¬¸)</label>
        <input type="text" id="addOpA" placeholder="ë³´ê¸° A" required />
        <input type="text" id="addOpB" placeholder="ë³´ê¸° B" required />
        <input type="text" id="addOpC" placeholder="ë³´ê¸° C" required />
        <input type="text" id="addOpD" placeholder="ë³´ê¸° D" required />

        <label>ì •ë‹µ (0=A, 1=B, 2=C, 3=D)</label>
        <input type="number" id="addAnswer" min="0" max="3" class="small-input" value="0" required />

        <label>í•´ì„¤ (ì˜ë¬¸, ì„ íƒ)</label>
        <textarea id="addExplanation"></textarea>

        <button type="submit" class="secondary" style="margin-top:8px;">ë¬¸ì œ ì¶”ê°€</button>
      </form>

      <hr style="margin:10px 0;">
      <h4>ğŸ“ JSON ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ</h4>
      <input type="file" id="uploadFileInput" accept=".json" />
      <button class="secondary" id="uploadFileBtn" style="margin-top:6px;">íŒŒì¼ì—ì„œ ë¬¸ì œ ì¶”ê°€</button>

      <p style="font-size:11px;color:#6b7280;">
        JSON ë°°ì—´ í˜•ì‹: { id, chapter, type, text, options[4], answer, explanation? }<br/>
        (ë¬¸ì œÂ·ë³´ê¸°Â·í•´ì„¤ì€ ëª¨ë‘ ì˜ì–´ë¡œë§Œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤. í•œêµ­ì–´ëŠ” ìë™ ìƒì„±)
      </p>

      <hr style="margin:10px 0;">
      <h4>ğŸ“¦ ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬</h4>
      <button class="danger" id="clearCustomBtn">ì‚¬ìš©ì ì¶”ê°€ ë¬¸ì œ ì‚­ì œ</button>
      <button class="secondary" id="exportCustomBtn" style="margin-top:4px;">ì‚¬ìš©ì ë¬¸ì œ JSON ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>
</div>

<script>
/******************************************************************
 * 0. ì„¤ì • â€” ë¹„ë°€ë²ˆí˜¸
 ******************************************************************/
const APP_PASSWORD = "cre2025";

/******************************************************************
 * 1. ê¸°ë³¸ ë¬¸ì œ ë°ì´í„° (ì˜ˆì‹œ ëª‡ ê°œë§Œ, ì‹¤ì œ ê¸°ì¶œì€ JSON ì—…ë¡œë“œë¡œ ì¶”ê°€)
 ******************************************************************/
const BASE_QUESTIONS = [
  { id:"Q1", chapter:"ìƒ˜í”Œ - Statistical Concepts", type:"C",
    text:"For an exponential distribution with MTBF = 800 hours, what is the reliability at 400 hours?",
    options:["0.50","0.61","0.37","0.80"], answer:1,
    explanation:"R(t) = exp(-t/MTBF) = exp(-400/800) = exp(-0.5) â‰ˆ 0.606" },

  { id:"Q2", chapter:"ìƒ˜í”Œ - Statistical Concepts", type:"A",
    text:"In a Weibull distribution, what does a shape parameter Î² greater than 1 indicate?",
    options:[
      "Early-life failures",
      "Wear-out failures with increasing failure rate",
      "Constant failure rate",
      "Random failures"
    ],
    answer:1,
    explanation:"Î²>1 means wear-out region with increasing hazard rate." },
];

/******************************************************************
 * 2. LocalStorage Helper
 ******************************************************************/
const loadWrongNotes = () => JSON.parse(localStorage.getItem("creWrongNotes")||"[]");
const saveWrongNotes = v => localStorage.setItem("creWrongNotes", JSON.stringify(v));

const loadScoreHistory = () => JSON.parse(localStorage.getItem("creScoreHistory")||"[]");
const saveScoreHistory = v => localStorage.setItem("creScoreHistory", JSON.stringify(v));

const loadCustomQuestions = () => JSON.parse(localStorage.getItem("creCustomQuestions")||"[]");
const saveCustomQuestions = v => localStorage.setItem("creCustomQuestions", JSON.stringify(v));

/******************************************************************
 * 3. ë™ì  ì±•í„° ë¦¬ìŠ¤íŠ¸ ìƒì„±
 ******************************************************************/
function refreshChapterDropdown() {
  const chSel = document.getElementById("chapterSelect");
  const chAdd = document.getElementById("addChapter");

  const all = BASE_QUESTIONS.concat(loadCustomQuestions());
  const chapters = new Set(["ì „ì²´"]);

  all.forEach(q => chapters.add(q.chapter));

  let htmlMain = "";
  let htmlAdd = "";

  chapters.forEach(ch => {
    htmlMain += `<option value="${ch==='ì „ì²´'?'all':ch}">${ch}</option>`;
    if (ch !== "ì „ì²´") htmlAdd += `<option value="${ch}">${ch}</option>`;
  });

  chSel.innerHTML = htmlMain;
  chAdd.innerHTML = htmlAdd;
}

/******************************************************************
 * 4. ë¬¸ì œ ì „ì²´ ê°€ì ¸ì˜¤ê¸°
 ******************************************************************/
const getAllQuestions = () => BASE_QUESTIONS.concat(loadCustomQuestions());

/******************************************************************
 * 5. ì˜¤ë‹µ / ì ìˆ˜ í‘œì‹œ
 ******************************************************************/
function renderWrongNotes(){
  const notes = loadWrongNotes();
  const box = document.getElementById("wrongNotesBox");
  if (!notes.length){
    box.innerHTML = `<div style="font-size:12px;color:#888;">ì˜¤ë‹µ ì—†ìŒ</div>`;
    return;
  }
  box.innerHTML = notes.map(n => `
    <div class="note-item">
      <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
      <div>${n.text}</div>
      <div style="font-size:11px;color:#666;">${n.chapter} Â· ${n.missCount}íšŒ Â· ${n.lastDate}</div>
    </div>
  `).join("");
}

function renderScoreHistory(){
  const hist = loadScoreHistory();
  const box = document.getElementById("scoreHistoryBox");
  if (!hist.length){
    box.innerHTML = `<div style="font-size:12px;color:#888;">ê¸°ë¡ ì—†ìŒ</div>`;
    return;
  }
  box.innerHTML = hist.slice().reverse().map(h => `
    <div class="score-item">
      <b>${h.date}</b> â€” ${h.correct}/${h.total} (${Math.round(h.correct/h.total*100)}%)
      <div style="font-size:11px;color:#555;">${h.mode} Â· ${h.durationSec}s</div>
    </div>
  `).join("");
}

function clearWrongNotes(){
  if (!confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  saveWrongNotes([]);
  renderWrongNotes();
}

function clearScoreHistory(){
  if (!confirm("ì ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
  saveScoreHistory([]);
  renderScoreHistory();
}

/******************************************************************
 * 6. íƒ€ì´ë¨¸
 ******************************************************************/
let timerId=null, timerSeconds=0, quizStarted=false, quizStartTime=null, currentQuiz=[];
let dualViewEnabled = false;  // ì˜/í•œ 2ë‹¨ ë³´ê¸° ëª¨ë“œ

function stopTimer(){
  if (timerId !== null){
    clearInterval(timerId);
    timerId = null;
  }
}

function updateTimerDisplay(){
  const el=document.getElementById("timer");
  if (timerSeconds<=0){
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSeconds/60)).padStart(2,"0");
  const s = String(timerSeconds%60).padStart(2,"0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startTimer(sec){
  stopTimer();
  timerSeconds = sec;
  updateTimerDisplay();

  if(sec<=0) return;

  timerId = setInterval(()=>{
    timerSeconds--;
    updateTimerDisplay();
    if(timerSeconds<=0){
      stopTimer();
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œë©ë‹ˆë‹¤.");
      submitQuiz(true);
    }
  },1000);
}

/******************************************************************
 * 7. ë°°ì—´ ì„ê¸°
 ******************************************************************/
const shuffleArray = arr => {
  const a=arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
};

/******************************************************************
 * 8. ê°„ë‹¨í•œ ì˜â†’í•œ ë²ˆì—­ ì—”ì§„
 *    - ì™„ë²½í•œ ë²ˆì—­ì´ ì•„ë‹ˆë¼, ì‹œí—˜ìš© ì£¼ìš” ìš©ì–´ ìœ„ì£¼ + íŒ¨í„´ ì¹˜í™˜
 ******************************************************************/
function translateTechTerm(text) {
  if (!text) return "";
  let out = text;

  const dict = {
    "reliability": "ì‹ ë¢°ë„",
    "reliability function": "ì‹ ë¢°ë„ í•¨ìˆ˜",
    "availability": "ê°€ìš©ë„",
    "operation availability": "ìš´ìš© ê°€ìš©ë„",
    "maintainability": "ì •ë¹„ì„±",
    "maintenance": "ìœ ì§€ë³´ìˆ˜",
    "scheduled maintenance": "ì •ê¸° ìœ ì§€ë³´ìˆ˜",
    "preventive maintenance": "ì˜ˆë°©ì •ë¹„",
    "corrective maintenance": "êµì •ì •ë¹„",
    "MTBF": "í‰ê· ê³ ì¥ê°„ê²©(MTBF)",
    "MTTR": "í‰ê· ìˆ˜ë¦¬ì‹œê°„(MTTR)",
    "MTTF": "í‰ê· ê³ ì¥ì‹œê°„(MTTF)",
    "failure rate": "ê³ ì¥ë¥ ",
    "hazard rate": "ìœ„í—˜ë¥ ",
    "exponential distribution": "ì§€ìˆ˜ë¶„í¬",
    "weibull distribution": "ì™€ì´ë¸” ë¶„í¬",
    "weibull": "ì™€ì´ë¸”",
    "accelerated life test": "ê°€ì†ìˆ˜ëª…ì‹œí—˜",
    "accelerated life testing": "ê°€ì†ìˆ˜ëª…ì‹œí—˜",
    "step-stress": "ìŠ¤í… ìŠ¤íŠ¸ë ˆìŠ¤",
    "common cause failure": "ê³µí†µì›ì¸ê³ ì¥",
    "fault tree analysis": "FTA(ê²°í•¨ìˆ˜ ë¶„ì„)",
    "design of experiments": "ì‹¤í—˜ê³„íšë²•(DOE)",
    "taguchi": "íƒ€êµ¬ì¹˜",
    "robust design": "ê°•ê±´ ì„¤ê³„",
    "reliability-centered maintenance": "RCM(ì‹ ë¢°ì„± ì¤‘ì‹¬ ë³´ì „)",
    "series system": "ì§ë ¬ ì‹œìŠ¤í…œ",
    "parallel system": "ë³‘ë ¬ ì‹œìŠ¤í…œ"
  };

  for (const [en, ko] of Object.entries(dict)) {
    const regex = new RegExp(en, "gi");
    out = out.replace(regex, `${ko} (${en})`);
  }
  return out;
}

function translateNaturalSentence(text) {
  if (!text) return "";
  let out = text;

  // ìì£¼ ë‚˜ì˜¤ëŠ” ì‹œí—˜ ë¬¸ì¥ íŒ¨í„´ ëª‡ ê°œ ë³€í™˜
  out = out.replace(/Which of the following/gi, "ë‹¤ìŒ ì¤‘");
  out = out.replace(/Which ONE of the following/gi, "ë‹¤ìŒ ë³´ê¸° ì¤‘ ì–´ëŠ ê²ƒ");
  out = out.replace(/Which is NOT/gi, "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€");
  out = out.replace(/Which of these/gi, "ë‹¤ìŒ í•­ëª© ì¤‘");
  out = out.replace(/is NOT/gi, "ì€(ëŠ”) ì•„ë‹ˆë‹¤");
  out = out.replace(/is/gi, "ì€(ëŠ”)");
  out = out.replace(/\?/g, "ì¸ê°€?");
  out = out.replace(/Expression for/gi, "~ì— ëŒ€í•œ ì‹ì€");

  // ë„ˆë¬´ ê¹¨ì§€ì§€ ì•Šê²Œ ì˜ì–´ ë¬¸ì¥ ì•ì— í•œê¸€ ì„¤ëª…ì„ ë¶™ì´ëŠ” ì •ë„ë¡œ ìœ ì§€
  return out;
}

function buildKoreanQuestionBlock(q) {
  const techQ = translateTechTerm(q.text);
  const natQ  = translateNaturalSentence(q.text);

  let html = `
    <div class="ko-header">Q${q._no} í•œê¸€ ë²ˆì—­</div>
    <div class="ko-label">ê¸°ìˆ  ë²ˆì—­</div>
    <div>${techQ || "(ë²ˆì—­ ëŒ€ìƒ í…ìŠ¤íŠ¸ ì—†ìŒ)"}</div>
    <div class="ko-label">ìì—° ë²ˆì—­</div>
    <div>${natQ || "(ì›ë¬¸ ë¬¸ì¥ì„ ì°¸ê³ í•˜ì„¸ìš”.)"}</div>
    <div class="ko-label" style="margin-top:6px;">ë³´ê¸° ë²ˆì—­</div>
  `;

  q.options.forEach((op, idx) => {
    const techOp = translateTechTerm(op);
    const natOp  = translateNaturalSentence(op);
    const ch = String.fromCharCode(65+idx);
    html += `
      <div class="ko-option">
        <b>${ch}.</b> ${techOp}
        <div style="margin-left:18px;">${natOp}</div>
      </div>
    `;
  });

  if (q.explanation) {
    const techExp = translateTechTerm(q.explanation);
    const natExp  = translateNaturalSentence(q.explanation);
    html += `
      <div class="ko-label" style="margin-top:6px;">í•´ì„¤ ë²ˆì—­</div>
      <div style="font-size:12px;">
        <b>ê¸°ìˆ :</b> ${techExp}<br/>
        <b>ìì—°:</b> ${natExp}
      </div>
    `;
  }

  return html;
}

/******************************************************************
 * 9. ë¬¸ì œ í™”ë©´ ì¶œë ¥ (ì˜ì–´ë§Œ / 2ë‹¨ ëª¨ë“œ)
 ******************************************************************/
function renderQuiz(){
  const box=document.getElementById("quizBox");
  box.innerHTML="";

  const dual = dualViewEnabled;

  currentQuiz.forEach((q,idx)=>{
    q._no = idx+1; // ë²ˆì—­ ë¸”ë¡ì—ì„œ ë²ˆí˜¸ ì‚¬ìš©

    if (!dual) {
      // ê¸°ì¡´ ë‹¨ì¼ ì˜ì–´ ëª¨ë“œ
      let h = `
        <div class="question-block">
          <div class="question-title">Q${idx+1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op,j)=>{
        h += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65+j)}. ${op}
            </label>
          </div>`;
      });
      h += "</div>";
      box.innerHTML += h;
    } else {
      // 2ë‹¨(ì˜/í•œ) ëª¨ë“œ
      let left = `
        <div class="q-left">
          <div class="question-title">Q${idx+1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op,j)=>{
        left += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65+j)}. ${op}
            </label>
          </div>`;
      });
      left += "</div>";

      const right = `<div class="q-right">${buildKoreanQuestionBlock(q)}</div>`;

      box.innerHTML += `<div class="question-block dual">${left}${right}</div>`;
    }
  });
}

/******************************************************************
 * 10. ì¶œì œ ëª¨ë“œ
 ******************************************************************/
function buildQuestionPool(){
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  const all = getAllQuestions();
  const notes = loadWrongNotes();

  if(mode==="normal"){
    return {
      pool: all.filter(q =>
        (ch==="all" || q.chapter===ch) &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:null
    };
  }

  if(mode==="wrong"){
    const set = new Set(notes.map(n=>n.id));
    return {
      pool: all.filter(q =>
        set.has(q.id) &&
        (ch==="all" || q.chapter===ch) &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:null
    };
  }

  if(mode==="weak"){
    if(!notes.length){
      alert("ì˜¤ë‹µë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return { pool:[], autoChapter:null };
    }
    const count={};
    notes.forEach(n => count[n.chapter]=(count[n.chapter]||0)+n.missCount);

    let weak=null, max=-1;
    for(const c in count){
      if(count[c]>max){ weak=c; max=count[c]; }
    }

    return {
      pool: all.filter(q =>
        q.chapter===weak &&
        (tp==="all" || q.type===tp)
      ),
      autoChapter:weak
    };
  }
}

/******************************************************************
 * 11. ì‹œí—˜ ì‹œì‘
 ******************************************************************/
function startQuiz(){
  const cnt = Number(document.getElementById("countInput").value);
  const tm  = Number(document.getElementById("timerInput").value);

  const { pool, autoChapter } = buildQuestionPool();
  if(!pool.length){
    alert("ì¶œì œ ê°€ëŠ¥í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  currentQuiz = shuffleArray(pool).slice(0, cnt || pool.length);
  renderQuiz();

  quizStarted=true;
  quizStartTime = Date.now();

  document.getElementById("resultBox").innerHTML="";
  document.getElementById("startBtn").disabled=true;
  document.getElementById("submitBtn").disabled=false;
  document.getElementById("resetBtn").disabled=false;

  const modeTxt=[];
  const mode=document.getElementById("modeSelect").value;

  modeTxt.push(
    mode==="normal" ? "ì¼ë°˜" :
    mode==="wrong"  ? "ì˜¤ë‹µë§Œ" :
                      "ì•½ì "
  );

  if(mode==="weak" && autoChapter)
    modeTxt.push(`ì±•í„°=${autoChapter}`);
  else {
    const ch=document.getElementById("chapterSelect").value;
    modeTxt.push(ch==="all" ? "ì „ì²´" : `ì±•í„°=${ch}`);
  }

  const tp=document.getElementById("typeSelect").value;
  modeTxt.push(tp==="all" ? "A+C" : `ìœ í˜•=${tp}`);
  modeTxt.push(`ë¬¸ì œ=${currentQuiz.length}`);

  document.getElementById("modeDesc").textContent = modeTxt.join(" / ");

  startTimer(tm>0 ? tm*60 : 0);
}

/******************************************************************
 * 12. ì˜¤ë‹µ ê¸°ë°˜ ìë™ ë³µìŠµë¬¸ì œ ìƒì„± ì—”ì§„
 ******************************************************************/
function autoGenerateQuestionsFromWrong(wrongList, notes){
  if(!wrongList || !wrongList.length) return;

  const custom = loadCustomQuestions();
  const allIds = new Set([
    ...BASE_QUESTIONS.map(q=>q.id),
    ...custom.map(q=>q.id)
  ]);

  let added = 0;

  wrongList.forEach(q=>{
    const note = notes.find(n => n.id === q.id);
    if(!note) return;

    // ìµœì†Œ 2íšŒ ì´ìƒ í‹€ë¦° ë¬¸ì œë§Œ ë³µìŠµë¬¸ì œ ìƒì„±
    if(note.missCount < 2) return;

    // ì´ë¯¸ ë³µìŠµë¬¸ì œë¥¼ ë§Œë“  ì  ìˆìœ¼ë©´ íŒ¨ìŠ¤
    const base = q.id + "-R";
    if (custom.some(c => c.id.startsWith(base))) return;

    const shuffledOptions = shuffleArray(q.options);
    const correctValue = q.options[q.answer];
    const newAnswerIdx = shuffledOptions.indexOf(correctValue);
    if(newAnswerIdx < 0) return;

    let newId = base;
    let n = 1;
    while(allIds.has(newId)){
      newId = base + n;
      n++;
    }
    allIds.add(newId);

    const newQ = {
      id: newId,
      chapter: q.chapter,
      type: q.type,
      text: "[Review] " + q.text,
      options: shuffledOptions,
      answer: newAnswerIdx,
      explanation: "(Auto-generated review question based on " + q.id + ") " + (q.explanation||"")
    };

    custom.push(newQ);
    added++;
  });

  if(added>0){
    saveCustomQuestions(custom);
    refreshChapterDropdown();
    console.log(`ìë™ ìƒì„± ë³µìŠµë¬¸ì œ ${added}ê°œ ì¶”ê°€ë¨`);
  }
}

/******************************************************************
 * 13. ì œì¶œ & ì±„ì 
 ******************************************************************/
function submitQuiz(auto=false){
  if(!quizStarted) return;
  quizStarted=false;
  stopTimer();

  const duration = Math.round((Date.now()-quizStartTime)/1000);
  let correct=0;
  const wrong=[];

  let html="";

  currentQuiz.forEach((q,idx)=>{
    const sel=document.querySelector(`input[name="q${idx}"]:checked`);
    const u = sel ? Number(sel.value) : null;

    const ok = (u === q.answer);
    if(ok) correct++;
    else wrong.push(q);

    const techQ = translateTechTerm(q.text);
    const natQ  = translateNaturalSentence(q.text);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx+1} (${q.id})</b><br>
        ì„ íƒ: ${u===null ? "ë¬´ì‘ë‹µ" : `${String.fromCharCode(65+u)}. ${q.options[u]}`}<br>
        ì •ë‹µ:
        <span style="color:${ok?"#16a34a":"#dc2626"}">
          ${String.fromCharCode(65+q.answer)}. ${q.options[q.answer]}
        </span>
        <div class="explanation">${q.explanation||""}</div>
        <div class="ko-result-block">
          <b>[ë¬¸ì œ ê¸°ìˆ  ë²ˆì—­]</b> ${techQ}<br/>
          <b>[ë¬¸ì œ ìì—° ë²ˆì—­]</b> ${natQ}
        </div>
      </div>
    `;
  });

  const pct = Math.round(correct/currentQuiz.length*100);

  document.getElementById("resultBox").innerHTML = `
    <h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>
    <div style="font-size:12px;color:#666;">
      ì†Œìš”ì‹œê°„: ${duration}s ${auto?"(ìë™ ì œì¶œ)":""}
    </div>
    ${html}
  `;

  document.getElementById("submitBtn").disabled=true;

  // ì˜¤ë‹µ ê¸°ë¡
  let notes = loadWrongNotes();
  if(wrong.length){
    const now=new Date().toLocaleString();

    wrong.forEach(q=>{
      const ex=notes.find(n=>n.id===q.id);
      if(ex){
        ex.missCount++;
        ex.lastDate = now;
      } else {
        notes.push({
          id:q.id, text:q.text, chapter:q.chapter, type:q.type,
          missCount:1, lastDate:now
        });
      }
    });

    saveWrongNotes(notes);
    renderWrongNotes();

    // ìë™ ë³µìŠµë¬¸ì œ ìƒì„±
    autoGenerateQuestionsFromWrong(wrong, notes);
  }

  // ì ìˆ˜ ì €ì¥
  const hist=loadScoreHistory();
  hist.push({
    date:new Date().toLocaleString(),
    mode:document.getElementById("modeDesc").textContent,
    total:currentQuiz.length,
    correct,
    durationSec:duration
  });
  saveScoreHistory(hist);
  renderScoreHistory();
}

/******************************************************************
 * 14. ì´ˆê¸°í™”
 ******************************************************************/
function resetQuiz(){
  stopTimer();
  quizStarted=false;
  currentQuiz=[];
  document.getElementById("quizBox").innerHTML="";
  document.getElementById("resultBox").innerHTML="";
  document.getElementById("modeDesc").textContent="";
  document.getElementById("timer").textContent="Timer: OFF";

  document.getElementById("startBtn").disabled=false;
  document.getElementById("submitBtn").disabled=true;
  document.getElementById("resetBtn").disabled=true;
}

/******************************************************************
 * 15. ë¬¸ì œ ì¶”ê°€ í¼
 ******************************************************************/
function setupAddQuestionForm(){
  const f=document.getElementById("addQuestionForm");

  f.addEventListener("submit", e=>{
    e.preventDefault();

    const q={
      id:document.getElementById("addId").value.trim(),
      chapter:document.getElementById("addChapter").value,
      type:document.getElementById("addType").value,
      text:document.getElementById("addText").value.trim(),
      options:[
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim()
      ],
      answer:Number(document.getElementById("addAnswer").value),
      explanation:document.getElementById("addExplanation").value.trim()
    };

    if(!q.id || !q.text || q.options.some(o=>!o) || q.answer<0 || q.answer>3){
      alert("í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    const custom = loadCustomQuestions();
    if(custom.some(c=>c.id===q.id) || BASE_QUESTIONS.some(b=>b.id===q.id)){
      alert("ID ì¤‘ë³µì…ë‹ˆë‹¤.");
      return;
    }

    custom.push(q);
    saveCustomQuestions(custom);
    refreshChapterDropdown();

    alert("ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!");
    f.reset();
  });
}

/******************************************************************
 * 16. JSON ë¬¸ì œ ì—…ë¡œë“œ
 ******************************************************************/
function setupUploadQuestions(){
  const input=document.getElementById("uploadFileInput");
  const btn=document.getElementById("uploadFileBtn");

  btn.addEventListener("click", ()=>{
    const file=input.files?.[0];
    if(!file){ alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }

    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const arr=JSON.parse(e.target.result);
        if(!Array.isArray(arr)){ alert("JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."); return; }

        const custom=loadCustomQuestions();
        const existing=new Set([
          ...BASE_QUESTIONS.map(q=>q.id),
          ...custom.map(q=>q.id)
        ]);

        const valid=[];
        arr.forEach((q,i)=>{
          if(!q.id || !q.chapter || !q.text ||
             !Array.isArray(q.options) || q.options.length!==4 ||
             typeof q.answer!=="number"){
            console.warn("ì œì™¸", i, q);
            return;
          }

          if(!("explanation" in q)) q.explanation="";

          if(!existing.has(q.id)) valid.push(q);
        });

        if(!valid.length){ alert("ì¶”ê°€í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        saveCustomQuestions(custom.concat(valid));
        refreshChapterDropdown();

        alert(`${valid.length}ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!`);
      }
      catch(err){
        console.error(err);
        alert("JSON íŒŒì‹± ì˜¤ë¥˜");
      }
    };

    reader.readAsText(file);
  });
}

/******************************************************************
 * 17. ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬
 ******************************************************************/
function setupCustomManagement(){
  document.getElementById("clearCustomBtn").addEventListener("click", ()=>{
    if(!confirm("ì‚¬ìš©ì ë¬¸ì œ ì „ì²´ ì‚­ì œ?")) return;
    saveCustomQuestions([]);
    refreshChapterDropdown();
  });

  document.getElementById("exportCustomBtn").addEventListener("click", ()=>{
    const data=loadCustomQuestions();
    if(!data.length){
      alert("ì €ì¥ëœ ì‚¬ìš©ì ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const blob=new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url=URL.createObjectURL(blob);

    const a=document.createElement("a");
    a.href=url;
    a.download="cre_custom_questions.json";
    a.click();

    URL.revokeObjectURL(url);
  });
}

/******************************************************************
 * 18. ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
 ******************************************************************/
function setupGate(){
  const ov=document.getElementById("gateOverlay");
  const input=document.getElementById("gatePassword");
  const btn=document.getElementById("gateBtn");
  const app=document.getElementById("appContainer");
  const msg=document.getElementById("gateMessage");

  function enter(){
    if(input.value===APP_PASSWORD){
      ov.style.display="none";
      app.style.display="block";

      renderWrongNotes();
      renderScoreHistory();
      refreshChapterDropdown();

      // 2ë‹¨ ë³´ê¸° ì„¤ì • ë³µì›
      const savedDual = localStorage.getItem("creDualView")==="1";
      const dualChk = document.getElementById("dualViewToggle");
      dualChk.checked = savedDual;
      dualViewEnabled = savedDual;
    } else {
      msg.textContent="ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter") enter();
  });
}

/******************************************************************
 * 19. ì˜/í•œ 2ë‹¨ ë³´ê¸° í† ê¸€ ì„¤ì •
 ******************************************************************/
function setupDualViewToggle(){
  const cb = document.getElementById("dualViewToggle");
  if(!cb) return;

  cb.addEventListener("change", ()=>{
    dualViewEnabled = cb.checked;
    localStorage.setItem("creDualView", dualViewEnabled ? "1" : "0");
    if(currentQuiz.length){
      renderQuiz(); // ê°™ì€ ë¬¸ì œë¡œ ë ˆì´ì•„ì›ƒë§Œ ë‹¤ì‹œ ë Œë”ë§
    }
  });
}

/******************************************************************
 * 20. ì´ˆê¸° ì‹¤í–‰
 ******************************************************************/
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("submitBtn").addEventListener("click", ()=>submitQuiz(false));
document.getElementById("resetBtn").addEventListener("click", resetQuiz);

setupAddQuestionForm();
setupUploadQuestions();
setupCustomManagement();
setupGate();
setupDualViewToggle();
</script>

</body>
</html>
